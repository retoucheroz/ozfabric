"use client"

import { useState, useRef, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Card } from "@/components/ui/card"
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs"
import { Switch } from "@/components/ui/switch"
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogDescription } from "@/components/ui/dialog"
import {
    Upload, Plus, Loader2, Trash2, Edit2, ChevronRight, ChevronLeft, Sparkles, User, Image as ImageIcon, Camera, RotateCw, X, Maximize2, FileText, ShoppingBag, Gem, MoveHorizontal, Glasses, Footprints, Shirt, ScanLine, Scissors, Ruler, Download, Package
} from "lucide-react"
import { useProjects } from "@/context/projects-context"
import { useLanguage } from "@/context/language-context"
import { toast } from "sonner"
import { useRouter } from "next/navigation"
import { Separator } from "@/components/ui/separator"
import { Textarea } from "@/components/ui/textarea"
import { resizeImageToThumbnail } from "@/lib/utils"
import { dbOperations, STORES } from "@/lib/db"
import { buildBatchSpecs, extractDominantColor, generateColorPaletteSVG, type BatchSpec } from "@/lib/batch-helpers"



// Define UserAddedPrompt state at module level or inside component?
// Inside component is better.


// Background Presets
const BACKGROUND_PRESETS = [
    { id: "studio", label: "Studio White", labelTr: "St√ºdyo Beyaz", preview: "https://images.unsplash.com/photo-1604014237800-1c9102c219da?w=200&h=200&fit=crop" },
    { id: "street", label: "Urban Street", labelTr: "≈ûehir Sokaƒüƒ±", preview: "https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=200&h=200&fit=crop" },
    { id: "nature", label: "Nature", labelTr: "Doƒüa", preview: "https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=200&h=200&fit=crop" },
    { id: "beach", label: "Beach", labelTr: "Plaj", preview: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=200&h=200&fit=crop" },
    { id: "gradient", label: "Gradient", labelTr: "Gradyan", preview: null, color: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" },
];

// Studio Steps Component for Loading Animation - Realistic 60-80 second process
const STUDIO_STEPS_TR = [
    { icon: "üö™", text: "St√ºdyo kapƒ±sƒ± a√ßƒ±lƒ±yor...", detail: "Set hazƒ±rlanƒ±yor" },
    { icon: "üîå", text: "Ekipmanlar a√ßƒ±lƒ±yor...", detail: "Sistemler kontrol ediliyor" },
    { icon: "üí°", text: "Ana ƒ±≈üƒ±klar kuruluyor...", detail: "Key light pozisyonlanƒ±yor" },
    { icon: "‚ú®", text: "Fill light ayarlanƒ±yor...", detail: "G√∂lge dengeleniyor" },
    { icon: "üåü", text: "Rim light ekleniyor...", detail: "Kontur aydƒ±nlatmasƒ±" },
    { icon: "üéöÔ∏è", text: "I≈üƒ±k ≈üiddeti kalibre ediliyor...", detail: "Exposure √∂l√ß√ºl√ºyor" },
    { icon: "üì∏", text: "Kamera ayarlarƒ± yapƒ±lƒ±yor...", detail: "ISO, aperture, shutter" },
    { icon: "üîç", text: "Odaklama kontrol ediliyor...", detail: "Auto-focus kalibrasyonu" },
    { icon: "üëî", text: "Kƒ±yafetler steamer ile √ºt√ºleniyor...", detail: "Kƒ±rƒ±≈üƒ±klƒ±klar gideriliyor" },
    { icon: "üßµ", text: "Son diki≈üler kontrol ediliyor...", detail: "Detaylar inceleniyor" },
    { icon: "üìê", text: "Styling d√ºzenleniyor...", detail: "Fit ayarlanƒ±yor" },
    { icon: "üé®", text: "Renk kartƒ± ile beyaz dengesi...", detail: "White balance ayarƒ±" },
    { icon: "üë§", text: "Model set'e alƒ±nƒ±yor...", detail: "Pozisyon ayarƒ±" },
    { icon: "üíÑ", text: "Son makyaj r√∂tu≈ülarƒ±...", detail: "Parlamalar kontrol ediliyor" },
    { icon: "üìã", text: "Test √ßekimi yapƒ±lƒ±yor...", detail: "Histogram kontrol" },
    { icon: "üñ•Ô∏è", text: "AI render ba≈ülatƒ±lƒ±yor...", detail: "GPU hesaplamasƒ±" },
    { icon: "‚öôÔ∏è", text: "G√∂r√ºnt√º i≈üleniyor...", detail: "Neural network aktif" },
    { icon: "üéûÔ∏è", text: "Son r√∂tu≈ülar uygulanƒ±yor...", detail: "Post-processing" },
    { icon: "üì∑", text: "Fotoƒüraf olu≈üturuluyor...", detail: "Export hazƒ±rlanƒ±yor" },
];

const STUDIO_STEPS_EN = [
    { icon: "üö™", text: "Opening studio...", detail: "Preparing set" },
    { icon: "üîå", text: "Powering up equipment...", detail: "Running system checks" },
    { icon: "üí°", text: "Setting up key light...", detail: "Positioning main light" },
    { icon: "‚ú®", text: "Adjusting fill light...", detail: "Balancing shadows" },
    { icon: "üåü", text: "Adding rim light...", detail: "Creating contour" },
    { icon: "üéöÔ∏è", text: "Calibrating light intensity...", detail: "Measuring exposure" },
    { icon: "üì∏", text: "Configuring camera...", detail: "ISO, aperture, shutter" },
    { icon: "üîç", text: "Checking focus...", detail: "Auto-focus calibration" },
    { icon: "üëî", text: "Steaming garments...", detail: "Removing wrinkles" },
    { icon: "üßµ", text: "Final stitch check...", detail: "Inspecting details" },
    { icon: "üìê", text: "Adjusting styling...", detail: "Perfecting fit" },
    { icon: "üé®", text: "White balance with color card...", detail: "Color calibration" },
    { icon: "üë§", text: "Model entering set...", detail: "Taking position" },
    { icon: "üíÑ", text: "Final makeup touchups...", detail: "Checking shine" },
    { icon: "üìã", text: "Test shot...", detail: "Histogram check" },
    { icon: "üñ•Ô∏è", text: "Starting AI render...", detail: "GPU processing" },
    { icon: "‚öôÔ∏è", text: "Processing image...", detail: "Neural network active" },
    { icon: "üéûÔ∏è", text: "Applying final touches...", detail: "Post-processing" },
    { icon: "üì∑", text: "Generating photo...", detail: "Preparing export" },
];

function StudioSteps({ language }: { language: string }) {
    const [currentStep, setCurrentStep] = useState(0);
    const [elapsedTime, setElapsedTime] = useState(0);
    const steps = language === "tr" ? STUDIO_STEPS_TR : STUDIO_STEPS_EN;

    // 19 steps over ~70 seconds = ~3.7 seconds per step
    const stepDuration = 3700;
    const estimatedTotal = 70; // seconds

    useEffect(() => {
        // Step timer
        const stepInterval = setInterval(() => {
            setCurrentStep((prev) => {
                // Don't loop - stay on last step until API responds
                if (prev >= steps.length - 1) return prev;
                return prev + 1;
            });
        }, stepDuration);

        // Elapsed time counter
        const timeInterval = setInterval(() => {
            setElapsedTime((prev) => prev + 1);
        }, 1000);

        return () => {
            clearInterval(stepInterval);
            clearInterval(timeInterval);
        };
    }, [steps.length]);

    const progress = Math.min((currentStep / (steps.length - 1)) * 100, 100);
    const estimatedRemaining = Math.max(estimatedTotal - elapsedTime, 0);

    return (
        <div className="w-full space-y-6">
            {/* Current Step Display */}
            <div className="text-center space-y-1">
                <div className="text-5xl mb-3" style={{ animation: 'pulse 1s ease-in-out infinite' }}>
                    {steps[currentStep].icon}
                </div>
                <h3 className="text-lg font-semibold text-foreground">
                    {steps[currentStep].text}
                </h3>
                <p className="text-sm text-muted-foreground">
                    {steps[currentStep].detail}
                </p>
            </div>

            {/* Progress Bar */}
            <div className="w-full space-y-2">
                <div className="h-2 w-full bg-card overflow-hidden rounded-full">
                    <div
                        className="h-full bg-gradient-to-r from-violet-600 via-pink-500 to-violet-600 rounded-full transition-all duration-500 ease-out"
                        style={{ width: `${progress}%` }}
                    />
                </div>
                <div className="flex justify-between text-xs text-muted-foreground">
                    <span>{Math.round(progress)}%</span>
                    <span>
                        {language === "tr"
                            ? `~${estimatedRemaining} saniye kaldƒ±`
                            : `~${estimatedRemaining}s remaining`}
                    </span>
                </div>
            </div>

            {/* Step Indicators - Compact */}
            <div className="flex justify-center gap-1 flex-wrap max-w-[280px] mx-auto">
                {steps.map((_, idx) => (
                    <div
                        key={idx}
                        className={`w-2 h-2 rounded-full transition-all duration-300 ${idx === currentStep
                            ? 'bg-violet-500 scale-150'
                            : idx < currentStep
                                ? 'bg-green-500'
                                : 'bg-zinc-700'
                            }`}
                    />
                ))}
            </div>

            {/* Elapsed Time */}
            <p className="text-xs text-center text-muted-foreground/70">
                {language === "tr"
                    ? `Ge√ßen s√ºre: ${elapsedTime}s ‚Ä¢ Adƒ±m ${currentStep + 1}/${steps.length}`
                    : `Elapsed: ${elapsedTime}s ‚Ä¢ Step ${currentStep + 1}/${steps.length}`}
            </p>
        </div>
    );
}


// Pose Presets
const POSE_PRESETS = [
    { id: "standing", label: "Standing", labelTr: "Ayakta", icon: "üßç", preview: null },
    { id: "walking", label: "Walking", labelTr: "Y√ºr√ºyen", icon: "üö∂", preview: null },
    { id: "sitting", label: "Sitting", labelTr: "Oturan", icon: "ü™ë", preview: null },
    { id: "hands-hips", label: "Hands on Hips", labelTr: "Eller Belde", icon: "üí™", preview: null },
    { id: "casual", label: "Casual", labelTr: "G√ºnl√ºk", icon: "üòé", preview: null },
    { id: "dynamic", label: "Dynamic", labelTr: "Dinamik", icon: "‚ö°", preview: null },
];

const ANGLE_PRESETS = [
    { id: "front-3/4", label: "Front 3/4", labelTr: "√ñn 3/4" },
    { id: "back-3/4", label: "Back 3/4", labelTr: "Arka 3/4" },
];

// Full list of Aspect Ratios
// Full list of Aspect Ratios
const ASPECT_RATIOS = [
    { id: "1:1", label: "1:1", labelTr: "1:1 (Kare)" },
    { id: "2:3", label: "2:3", labelTr: "2:3 (Portre)" },
    { id: "3:4", label: "3:4", labelTr: "3:4 (Portre)" },
    { id: "4:3", label: "4:3", labelTr: "4:3 (Yatay)" },
    { id: "16:9", label: "16:9", labelTr: "16:9" },
    { id: "9:16", label: "9:16", labelTr: "9:16" },
];

// Full list of Resolutions
const RESOLUTION_OPTIONS = [
    { id: "1K", label: "1K Standard", labelTr: "1K Standart", credits: 4 },
    { id: "2K", label: "2K High", labelTr: "2K Y√ºksek", credits: 4 },
    { id: "4K", label: "4K Ultra", labelTr: "4K Ultra", credits: 8 },
];

// Defines a saved item structure with custom thumbnail support
interface LibraryItem {
    id: string;
    url: string;        // The actual asset URL (base64 or cloud)
    name: string;       // Display name
    thumbUrl?: string;  // OPTIONAL: Custom preview image
    createdAt: number;
}

// Specialized interfaces
interface SavedPose extends LibraryItem {
    originalThumb: string; // The thumb used currently, we'll merge this into thumbUrl soon
    stickmanUrl: string;   // The API result
    gender: 'male' | 'female';
    customPrompt?: string; // New: Custom prompt for this pose
}

interface SavedModel extends LibraryItem {
    gender: 'male' | 'female';
}

interface SavedBackground extends LibraryItem { }
interface SavedFit extends LibraryItem {
    customPrompt?: string; // New: Custom prompt for this fit/pattern
}
interface SavedShoe extends LibraryItem { }




export default function PhotoshootPage() {
    const { projects, addProject, deductCredits, models } = useProjects();
    const { t, language } = useLanguage();
    const router = useRouter();
    const [mounted, setMounted] = useState(false);

    useEffect(() => {
        setMounted(true);
    }, []);

    // Smart Workflow State
    // Smart Workflow State
    const [productName, setProductName] = useState("");
    const [workflowType, setWorkflowType] = useState<"upper" | "lower" | "dress" | "set">("upper");

    // Asset State
    const [assets, setAssets] = useState<{ [key: string]: string | null }>({
        model: null,
        background: null,
        main_product: null, // For simple mode
        pose: null,
        top_front: null,
        bottom_front: null,
        shoes: null,
        top_back: null,
        bottom_back: null,
        jacket: null,
        bag: null,
        glasses: null,
        hat: null,
        jewelry: null,
        belt: null, // NEW: Belt support
        inner_wear: null // NEW: Inner wear support   
    });

    // Phase 3: Button/Zipper State
    const [buttonsOpen, setButtonsOpen] = useState(false);
    const [closureType, setClosureType] = useState<'buttons' | 'zipper' | 'none'>('buttons');

    // Phase 3: Prompt Editor
    const [userAddedPrompt, setUserAddedPrompt] = useState("");

    // Analyzed Pose & Product Descriptions
    const [poseDescription, setPoseDescription] = useState<string | null>(null);
    const [poseStickman, setPoseStickman] = useState<string | null>(null); // NEW: Stickman for ControlNet
    const [productDescription, setProductDescription] = useState<string | null>(null);
    const [fitDescription, setFitDescription] = useState<string | null>(null);
    const [upperGarmentDescription, setUpperGarmentDescription] = useState<string | null>(null); // NEW
    const [innerWearDescription, setInnerWearDescription] = useState<string | null>(null); // NEW

    // Phase 4: Tuck Logic (Default Untucked false)
    const [tucked, setTucked] = useState(false);
    const [hairBehindShoulders, setHairBehindShoulders] = useState(false);
    const [lookAtCamera, setLookAtCamera] = useState(true);
    const [socksType, setSocksType] = useState<'none' | 'white' | 'black'>('none');

    // BATCH GENERATION (Mavi Almanya Integration)
    const [productCode, setProductCode] = useState("");
    const [batchMode, setBatchMode] = useState(false);
    const [upperFraming, setUpperFraming] = useState<"full" | "medium_full">("medium_full");
    const [batchPreviewPrompts, setBatchPreviewPrompts] = useState<any[]>([]);
    const [showBatchPreview, setShowBatchPreview] = useState(false);
    const [editedBatchPrompts, setEditedBatchPrompts] = useState<string[]>([]);
    const [batchResultImages, setBatchResultImages] = useState<any[]>([]);
    const [colorPalette, setColorPalette] = useState<string | null>(null);


    const [poseFocus, setPoseFocus] = useState<'upper' | 'full' | 'lower' | 'closeup'>('full');
    const [detailView, setDetailView] = useState<'front' | 'angled' | 'back'>('front');

    // AUTO-SET removed as per user request for manual control
    // useEffect(() => { ... }, [workflowType]);

    // === IMAGE RESIZE CONFIGURATION ===
    const getMaxSizeForAsset = (key: string): number => {
        // Model and main product fronts: 2048px
        if (['model', 'main_product', 'top_front', 'bottom_front', 'detail_1', 'detail_2', 'detail_3'].includes(key)) {
            return 2048;
        }
        // Back views and inner wear: 1536px
        if (['top_back', 'bottom_back', 'inner_wear', 'background', 'backRefUpload', 'fit_pattern'].includes(key)) {
            return 1536;
        }
        // Pose reference: 1024px
        if (key === 'pose') {
            return 1024;
        }
        // Default for accessories: 1536px
        return 1536;
    };

    // === RESIZE IMAGE UTILITY ===
    const resizeImage = (file: File, maxSize: number): Promise<string> => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const reader = new FileReader();

            reader.onload = (e) => {
                img.onload = () => {
                    let { width, height } = img;

                    // Only resize if larger than maxSize
                    if (width > maxSize || height > maxSize) {
                        const ratio = Math.min(maxSize / width, maxSize / height);
                        width = Math.round(width * ratio);
                        height = Math.round(height * ratio);
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    if (!ctx) {
                        reject(new Error('Canvas context not available'));
                        return;
                    }

                    // Use high quality resizing
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to JPEG for smaller file size (quality 0.92)
                    const resizedDataUrl = canvas.toDataURL('image/jpeg', 0.92);
                    console.log(`Resized ${file.name}: ${img.naturalWidth}x${img.naturalHeight} ‚Üí ${width}x${height}`);
                    resolve(resizedDataUrl);
                };

                img.onerror = () => reject(new Error('Image load failed'));
                img.src = e.target?.result as string;
            };

            reader.onerror = () => reject(new Error('File read failed'));
            reader.readAsDataURL(file);
        });
    };

    // Auto-detect workflow type
    useEffect(() => {
        const lowerKeywords = ["pantolon", "etek", "≈üort", "jean", "trousers", "skirt", "shorts", "denim", "tayt"];
        const isLower = lowerKeywords.some(k => productName.toLowerCase().includes(k));
        setWorkflowType(isLower ? "lower" : "upper");
    }, [productName]);

    const handleAssetUpload = async (key: string, file: File) => {
        try {
            const maxSize = getMaxSizeForAsset(key);
            const resizedDataUrl = await resizeImage(file, maxSize);
            setAssets(prev => ({ ...prev, [key]: resizedDataUrl }));

            // Analyze Pose if uploaded to 'pose' slot
            // ASK TO SAVE BEFORE CONVERTING
            if (key === 'pose') {
                setPoseDescription(null); // Reset previous analysis

                // Set temp data for potential save
                setTempPoseData({
                    original: resizedDataUrl,
                    stickman: "" // Not yet generated
                });

                // Show Pre-Conversion Dialog
                setShowSavePoseDialog(true);
            }

            // MODEL UPLOAD - PROMPT TO SAVE
            if (key === 'model') {
                setTempModelData({
                    url: resizedDataUrl,
                    name: "",
                    gender: 'female' // Default, user can change
                });
                setShowSaveModelDialog(true);
            }

            // NEW ASSET SAVING LOGIC
            if (key === 'background') {
                setTempAssetData({ key: 'background', url: resizedDataUrl, name: "" });
                setShowSaveAssetDialog(true);
            }
            if (key === 'fit_pattern') {
                setTempAssetData({ key: 'fit_pattern', url: resizedDataUrl, name: "" });
                setShowSaveAssetDialog(true);
            }
            if (key === 'shoes') {
                setTempAssetData({ key: 'shoes', url: resizedDataUrl, name: "" });
                setShowSaveAssetDialog(true);
            }

            // Reset descriptions if main items change, but DO NOT ANALYZE yet
            if (['main_product', 'top_front', 'detail_1', 'detail_2', 'bottom_front'].includes(key)) {
                if (key === 'main_product' || key === 'top_front' || key === 'bottom_front') {
                    setProductDescription(null);
                    setUpperGarmentDescription(null);
                    setInnerWearDescription(null);
                    setUserAddedPrompt("");
                }
            }

            if (key === 'fit_pattern') {
                setFitDescription(null);
            }
        } catch (error) {
            console.error('Image resize failed:', error);
            toast.error(language === "tr" ? "G√∂rsel i≈ülenemedi" : "Image processing failed");
        }
    };

    const analyzePose = async (imageUrl: string) => {
        try {
            toast.info(language === "tr" ? "Poz analizi yapƒ±lƒ±yor..." : "Analyzing pose...");
            const res = await fetch("/api/analyze-pose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ imageUrl })
            });
            const data = await res.json();
            if (data.description) {
                setPoseDescription(data.description);
                toast.success(language === "tr" ? "Poz analizi tamamlandƒ±" : "Pose analysis complete");
            }
        } catch (e) {
            console.error("Pose analysis failed", e);
        }
    };

    const analyzeProduct = async (file: File) => {
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64 = reader.result as string;
            try {
                toast.info(language === "tr" ? "Kuma≈ü & Doku analiz ediliyor..." : "Analyzing fabric & texture...");
                const res = await fetch("/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        image: base64,
                        type: 'techPack',
                        language
                    })
                });

                if (!res.ok) throw new Error("Product Analysis failed");

                const data = await res.json();
                // Extract relevant fabric info from JSON
                if (data.data) {
                    if (data.data.productName) setProductName(data.data.productName);

                    let desc = "";

                    // Priority: Use the "Textile Technologist" formatted visualPrompt
                    if (data.data.visualPrompt) {
                        desc = data.data.visualPrompt;
                    } else {
                        // Fallback to old format
                        desc = `Fabric: ${data.data.fabric?.main}, ${data.data.fabric?.finish}. Texture: ${data.data.designNotes}.`;
                    }

                    setProductDescription(desc);

                    // Auto-detect closure type (buttons vs zipper)
                    if (data.data.closureType) {
                        const detected = data.data.closureType.toLowerCase();
                        if (detected.includes('zipper') || detected.includes('zip')) {
                            setClosureType('zipper');
                        } else if (detected.includes('button')) {
                            setClosureType('buttons');
                        } else {
                            setClosureType('none');
                        }
                        console.log("Detected closure type:", data.data.closureType);
                    }

                    toast.success(language === "tr" ? "√úr√ºn analizi tamamlandƒ±" : "Product analysis complete");
                    console.log("Product Analysis:", desc);
                }
            } catch (err) {
                console.error("Product analysis error:", err);
                // Don't toast error to avoid spamming user if API fails silently
            }
        };
        reader.readAsDataURL(file);
    };



    // Manual Stickman Conversion
    const convertToStickman = async () => {
        const currentPose = assets.pose;
        if (!currentPose) return;

        try {
            toast.info(language === "tr" ? "Stickman olu≈üturuluyor..." : "Applying Skeletal Pose...");

            // Assume currentPose is base64 or url. If url, we pass it. If base64 we pass it.
            // Our api/pose handles image_url which accepts data uri.

            const res = await fetch("/api/pose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image_url: currentPose })
            });

            if (!res.ok) {
                const errJson = await res.json().catch(() => ({}));
                throw new Error(errJson.error || `Stickman failed: ${res.status}`);
            }
            const data = await res.json();

            if (data.pose_image) {
                const stickmanUrl = data.pose_image;

                // 1. Replace Asset Visual
                setAssets(prev => ({ ...prev, pose: stickmanUrl }));

                // 2. Set State
                setPoseStickman(stickmanUrl);

                // 3. Trigger Save Dialog
                setTempPoseData({
                    original: currentPose, // The original upload (base64/url)
                    stickman: stickmanUrl
                });
                setShowSavePoseDialog(true);

                // 3. Add to Library (Both original and stickman if possible, but here just stickman)
                if (!sessionLibrary.includes(stickmanUrl)) {
                    setSessionLibrary(prev => [stickmanUrl, ...prev]);
                }

                toast.success(language === "tr" ? "Poz d√∂n√º≈üt√ºr√ºld√º!" : "Pose converted to Stickman!");
            }
        } catch (e) {
            console.error(e);
            toast.error("Failed to convert pose");
        }
    };

    // FIT/PATTERN ANALYSIS for pants/jeans
    const analyzeFit = async (file: File) => {
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64 = reader.result as string;
            try {
                toast.info(language === "tr" ? "Kalƒ±p/Fit analiz ediliyor..." : "Analyzing fit/pattern...");
                const res = await fetch("/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        image: base64,
                        type: 'fit',
                        language
                    })
                });

                if (!res.ok) throw new Error("Fit analysis failed");

                const data = await res.json();
                if (data.data?.fitDescription) {
                    setFitDescription(data.data.fitDescription);
                    toast.success(language === "tr" ? "Kalƒ±p analizi tamamlandƒ±" : "Fit analysis complete");
                    console.log("Fit Description:", data.data.fitDescription);
                }
            } catch (err) {
                console.error("Fit analysis error:", err);
                toast.error(language === "tr" ? "Kalƒ±p analizi ba≈üarƒ±sƒ±z" : "Fit analysis failed");
            }
        };
        reader.readAsDataURL(file);
    };

    const removeAsset = (key: string) => {
        setAssets(prev => ({ ...prev, [key]: null }));
        if (key === 'pose') {
            setPoseDescription(null);
            setPoseStickman(null);
        }
        if (key === 'main_product' || key === 'top_front' || key === 'bottom_front') {
            setProductDescription(null);
            setUpperGarmentDescription(null);
            setInnerWearDescription(null);
        }
        if (key === 'fit_pattern') setFitDescription(null);
    };

    // State for Generation
    const [isProcessing, setIsProcessing] = useState(false);
    const [resultImages, setResultImages] = useState<string[] | null>(null);
    const [generationStage, setGenerationStage] = useState<'idle' | 'generating' | 'complete'>('idle');
    const [previewData, setPreviewData] = useState<any>(null);
    const [previewMode, setPreviewMode] = useState<'text' | 'json'>('json'); // Default to JSON as requested
    const [showPreview, setShowPreview] = useState(false);
    const [pendingOptions, setPendingOptions] = useState<any>(null);

    const handleGenerate = async (options: { isThreeAngles?: boolean, isReStyling?: boolean, targetView?: string } = {}) => {
        const { isThreeAngles = false, isReStyling = false, targetView } = options;

        if (isReStyling) {
            setStylingIteration(prev => prev + 1);
        } else if (!isThreeAngles) {
            setStylingIteration(0);
        }

        if (!assets.model) {
            toast.error(language === "tr" ? "L√ºtfen bir model g√∂rseli y√ºkleyin" : "Please upload a model image");
            return;
        }

        setIsProcessing(true);
        if (!isReStyling && !isThreeAngles) setResultImages(null);

        // Auto-close asset drawer
        setActiveLibraryAsset(null);

        // === PRE-ANALYSIS STEP (Wait for analyses to complete) ===
        // Analyze assets if descriptions are missing
        let currentPoseDesc = poseDescription;
        let currentProductDesc = productDescription;
        let currentClosureType = closureType;
        let currentProductName = productName;
        let currentUpperDesc = upperGarmentDescription;
        let currentInnerDesc = innerWearDescription;

        // 1. Pose Analysis - DISABLED as per user request. 
        // Descriptions are now either from library (handleSavedPoseClick) or manual JSON edits.
        if (!isReStyling) {
            if (poseStickman && !currentPoseDesc) {
                currentPoseDesc = "Use stickman reference";
                setPoseDescription(currentPoseDesc);
            }
        }

        // 2. Collective Garment Analysis (Analyze all primary garment angles together)
        let garmentImages: string[] = [];
        if (workflowType === 'lower') {
            garmentImages = [assets.bottom_front, assets.main_product, assets.bottom_back, assets.detail_1, assets.detail_2, assets.detail_3].filter(Boolean) as string[];
        } else if (workflowType === 'upper') {
            garmentImages = [assets.top_front, assets.main_product, assets.top_back, assets.detail_1, assets.detail_2, assets.detail_3].filter(Boolean) as string[];
        } else if (workflowType === 'dress') {
            garmentImages = [assets.dress_front, assets.main_product, assets.detail_1, assets.detail_2, assets.detail_3].filter(Boolean) as string[];
        } else {
            // set or other
            garmentImages = [assets.main_product, assets.top_front, assets.bottom_front, assets.detail_1, assets.detail_2, assets.detail_3].filter(Boolean) as string[];
        }

        if (!isReStyling && garmentImages.length > 0 && !currentProductDesc) {
            try {
                toast.info(language === "tr" ? "√úr√ºn toplu analizi yapƒ±lƒ±yor..." : "Analyzing garment collective views...");
                const res = await fetch("/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ images: garmentImages, type: 'fabric', language })
                });
                const data = await res.json();
                if (data.data) {
                    if (data.data.visualPrompt) {
                        currentProductDesc = data.data.visualPrompt;
                        setProductDescription(currentProductDesc);
                    }
                    if (data.data.fitDescription) {
                        setFitDescription(data.data.fitDescription);
                    }
                    if (data.data.productName && !currentProductName) {
                        currentProductName = data.data.productName;
                        setProductName(currentProductName);
                    }
                    if (data.data.closureType) {
                        const detected = data.data.closureType.toLowerCase();
                        if (detected.includes('zipper') || detected.includes('zip')) {
                            currentClosureType = 'zipper';
                            setClosureType('zipper');
                        } else if (detected.includes('button')) {
                            currentClosureType = 'buttons';
                            setClosureType('buttons');
                        } else {
                            currentClosureType = 'none';
                            setClosureType('none');
                        }
                    }
                }
            } catch (e) {
                console.error("Collective product analysis failed", e);
            }
        }

        // NOTE: Secondary analyses (upper/inner/pose/fit) are skipped or consolidated into the main collective flow per user request.

        // If product name is still missing, warn user but proceed if we have images
        if (!currentProductName && !productName) {
            // Optional: Force user to enter name?
            // toast.warning("Product name missing, using generic name.");
            currentProductName = "Fashion Garment";
        }


        setUserAddedPrompt(""); // CRITICAL: Reset prompt override at start of new generation
        try {
            const detailImages = [assets.detail_1, assets.detail_2, assets.detail_3].filter(Boolean);

            // Workflow type is now manually selected via state 'workflowType'
            // No need to calculate it from keywords.

            let currentFocus = poseFocus;
            // Alternating logic for "New Styling" (ONLY for Upper Body workflows)
            // For Lower/Dress/Set, we usually want to keep Full Body or Lower Focus to see the product.
            if (!isThreeAngles && generationStage === 'complete' && workflowType === 'upper') {
                // If we are generating AGAIN (New Styling), toggle focus
                const base = 'full';
                const alternate = 'upper';
                // 0=Full, 1=Upper, 2=Full...
                currentFocus = (stylingIteration % 2 === 0) ? base : alternate;
            }

            // Determine gender
            const selectedModel = savedModels.find(m => m.url === assets.model);
            let modelGender = selectedModel ? selectedModel.gender : "model";

            // If custom model, try to infer gender from text inputs
            if (modelGender === "model") {
                const combinedText = (currentProductName + " " + (assets.prompt || "")).toLowerCase();
                if (combinedText.includes("erkek") || combinedText.includes("bay ") || combinedText.includes("male") || combinedText.includes("man")) {
                    modelGender = "male";
                } else if (combinedText.includes("kadƒ±n") || combinedText.includes("bayan") || combinedText.includes("female") || combinedText.includes("woman")) {
                    modelGender = "female";
                }
            }

            const response = await fetch("/api/generate", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    productName: currentProductName || productName, // Use analyzed or manual name
                    workflowType, // Use STATE
                    uploadedImages: assets,
                    detailImages,
                    gender: gender || modelGender,
                    prompt: assets.prompt,
                    poseFocus: currentFocus,
                    isAngles: isThreeAngles,
                    resolution,
                    aspectRatio,
                    upperGarmentDescription: currentUpperDesc,
                    innerWearDescription: currentInnerDesc,
                    closureType: currentClosureType,
                    hairBehindShoulders,
                    lookAtCamera,
                    buttonsOpen,
                    tucked,
                    socksType,
                    preview: true // Phase 3: FORCE PREVIEW first
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || errData.message || "Generation failed");
            }

            const data = await response.json();

            // Direct success handling
            if (data.images) {
                setResultImages(data.images);
                setGenerationStage('complete');
                toast.success(language === "tr" ? "Olu≈üturuldu!" : "Generated!");
                setIsProcessing(false);
                return;
            }

            if (data.status === "preview") {
                setPreviewData(data.previews); // Array of preview objects
                // Populate editor with first preview's prompt
                // Populate editor with JSON or Text depending on mode
                if (data.previews && data.previews.length > 0) {
                    if (previewMode === 'json') {
                        setUserAddedPrompt(JSON.stringify(data.previews[0].structured, null, 2));
                    } else {
                        setUserAddedPrompt(data.previews[0].prompt);
                    }
                }
                setPendingOptions(options); // Store options to re-use for confirmation
                setShowPreview(true);
                setIsProcessing(false); // Stop loading, show modal
                return;
            }

            // Fallback if preview flag ignored (should not happen)
            if (data.images) {
                setResultImages(data.images);
                setGenerationStage('complete');
                toast.success("Generated!");

                // PERSISTENCE (Auto-Save) - Fallback
                if (data.images && data.images.length > 0) {
                    data.images.forEach((img: string) => {
                        addProject({
                            title: `Photoshoot - ${productName} - ${new Date().toLocaleTimeString()}`,
                            type: "Photoshoot",
                            imageUrl: img,
                            description: `Generated for ${productName} (${workflowType})`
                        });
                    });
                }
            }

        } catch (error) {
            console.error("Generation error:", error);
            // @ts-ignore
            toast.error(error.message || (language === "tr" ? "Olu≈üturma ba≈üarƒ±sƒ±z oldu" : "Generation failed"));
            setIsProcessing(false);
        }
    };

    const handleConfirmGeneration = async () => {
        setShowPreview(false);
        setIsProcessing(true);
        const isReStyling = pendingOptions?.isReStyling || false;
        if (!isReStyling && !pendingOptions?.isThreeAngles) setResultImages(null);

        try {
            // We need to re-call the API but with preview: false. 
            // We need to reconstruct the payload logic or just pass the SAME logic?
            // The API is stateless, so we must send all data again.
            // To reuse logic, we can extract the payload construction, OR just re-run the body construction.
            // Since `handleGenerate` uses current state `assets`, `productName`, etc., and they haven't changed, 
            // we can just re-run the fetch.

            // Issue: `handleGenerate` had local variables like `workflowType` derived from state.
            // We should probably allow `handleGenerate` to accept a `skipPreview` flag?

            // We need to pass the EDITED prompt if it changed.
            // But `executeRealGeneration` calls API which REBUILDS prompt.
            // So we need to pass `editedPrompt` as an override/append.

            // Map the edits from `previewData` to a simpler structure? 
            // Actually, since we only edit ONE prompt usually (or multiple), 
            // for simplicity let's assume valid detailed edit for now.
            // If the user edited specific text, we pass that as `editedPrompt` param.
            // Let's grab the first prompt's text as "extra instruction" maybe?
            // Or ideally, `customPrompt` (assets.prompt) + `editedSuffix`.

            // Simplest approach: Pass an `editedPrompt` string that backend APPENDS.
            // In the modal, we likely edited the FULL text.
            // So we might need `editedPrompt` to be the *difference* or just append.
            // User requirement: "Ekleyeceƒüim prompt varolana ek olarak i≈ülensin." -> Append.

            // So in the modal we should have an "Additional Prompt" field? 
            // Or edit the full thing? "final promptuna d√ºzenleme yapabileyim" implies editing result.
            // If technical constraint prevents replacing full prompt easily on backend (dynamic logic),
            // let's pass the "Extra" text.

            // For this implementation: Let's extract the "User Edits".
            // If the user modified the text in the text area, we send that entire string as `editedPrompt`.
            // But backend appends it. So if I send "Full Prompt", it becomes "Full Prompt Full Prompt".
            // Backend change: `if (editedPrompt) finalPrompt += editedPrompt`.

            // Let's use a specialized state `userAddedPrompt` in the Preview Dialog.

            await executeRealGeneration({
                ...pendingOptions,
                targetView: pendingOptions?.targetView, // Critical: Pass targetView for single-angle mode
                editedPrompt: userAddedPrompt // New param
            });

        } catch (error) {
            console.error(error);
            toast.error("Failed");
            setIsProcessing(false);
        }
    };

    const executeRealGeneration = async (options: { isThreeAngles?: boolean, isReStyling?: boolean, targetView?: string, editedPrompt?: string } = {}) => {
        const { isThreeAngles = false, isReStyling = false, targetView, editedPrompt } = options;

        // Re-derive logic (copy-paste from handleGenerate mostly, or refactor?)
        // Refactoring `handleGenerate` to separate function is risky with tool limits.
        // I will implement the fetch call here directly using current state.

        const detailImages = [assets.detail_1, assets.detail_2].filter(Boolean);
        // Use state instead of re-calculating to ensure consistency
        // const workflowType = lowerKeywords.some(k => productName.toLowerCase().includes(k)) ? 'lower' : 'upper';

        let currentFocus = poseFocus;
        if (!isThreeAngles && generationStage === 'complete') {
            const base = 'full';
            const alternate = 'upper';
            currentFocus = (stylingIteration % 2 === 0) ? base : alternate;
        }

        const selectedModel = savedModels.find(m => m.url === assets.model);
        let modelGender = selectedModel ? selectedModel.gender : "model";
        if (modelGender === "model") {
            const combinedText = (productName + " " + (assets.prompt || "")).toLowerCase();
            if (combinedText.includes("erkek") || combinedText.includes("bay ") || combinedText.includes("male") || combinedText.includes("man")) {
                modelGender = "male";
            } else if (combinedText.includes("kadƒ±n") || combinedText.includes("bayan") || combinedText.includes("female") || combinedText.includes("woman")) {
                modelGender = "female";
            }
        }

        const response = await fetch("/api/generate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                productName,
                workflowType,
                uploadedImages: assets,
                gender: gender || modelGender, // Pass manual gender OR inferred
                prompt: assets.prompt, // Use assets.prompt
                poseFocus: poseFocus, // Use state directly
                resolution: resolution, // Pass explicitly
                aspectRatio: aspectRatio, // Pass explicitly
                isAngles: isThreeAngles,
                preview: false, // REAL GENERATION
                poseDescription, // Pass analyzed pose
                poseStickman, // Pass stickman URL
                hairBehindShoulders,
                lookAtCamera,
                buttonsOpen,
                tucked,
                socksType,
                detailView, // Pass Detail View selection
                targetView, // Pass single-view target (front/side/back)
                upperGarmentDescription,
                innerWearDescription,
                closureType,
                productDescription, // Pass fabric analysis
                fitDescription, // Pass fit analysis
                editedPrompt // Pass user additional prompt
            })
        });

        if (!response.ok) {
            let errorMessage = "Generation failed";
            try {
                const err = await response.json();
                errorMessage = err.error || err.message || errorMessage;
            } catch (jsonErr) {
                errorMessage = `HTTP Error ${response.status} - ${response.statusText}`;
            }
            console.error("GENERATE API ERROR:", errorMessage);
            throw new Error(errorMessage);
        }
        const data = await response.json();

        if (data.images) {
            setResultImages(data.images);
            setGenerationStage('complete');

            toast.success(isThreeAngles
                ? (language === "tr" ? "3'l√º a√ßƒ± seti olu≈üturuldu!" : "3-Angle set generated!")
                : (language === "tr" ? "Styling g√∂rseli olu≈üturuldu!" : "Styling shot generated!")
            );

            // PERSISTENCE (Auto-Save) - REAL Generation
            data.images.forEach((img: string, idx: number) => {
                const finalPrompt = (data.prompts && data.prompts[idx]) ? data.prompts[idx] : `Generated for ${productName}`;
                addProject({
                    title: `Photoshoot - ${productName} - ${new Date().toLocaleTimeString()}`,
                    type: "Photoshoot",
                    imageUrl: img,
                    description: finalPrompt // Save the prompt here!
                });
            });

            if (!isThreeAngles) setStylingIteration(prev => prev + 1);
        }
        setIsProcessing(false);
    };

    // === BATCH GENERATION FUNCTIONS (Mavi Almanya Integration) ===
    const buildBatchSpecs = (prodName: string, genderVal: 'male' | 'female') => {
        const getRandomPose = (type: 'random' | 'angled'): string => {
            const poses = type === 'random'
                ? (genderVal === 'female'
                    ? ["Standing with one hand on hip, weight shifted to left leg", "Hands in pockets, relaxed stance", "Arms crossed casually", "One hand touching hair"]
                    : ["Standing with hands in pockets, shoulders relaxed", "Arms at sides, weight on one leg", "One hand in pocket, other relaxed", "Hands clasped in front"])
                : (genderVal === 'female'
                    ? ["Body rotated 45 degrees to the right, looking over shoulder", "Three-quarter turn to the left, hands on hips", "Slight rotation showing side profile"]
                    : ["Body rotated 45 degrees to the right, looking at camera", "Three-quarter turn to the left, hands in pockets", "Slight rotation showing side profile"]);
            return poses[Math.floor(Math.random() * poses.length)];
        };

        if (workflowType === 'upper') {
            return [
                { view: "styling", pose: poseDescription || getRandomPose('random'), dynamic: true, camera: { shot_type: upperFraming === 'full' ? 'full_body' : 'cowboy_shot', framing: upperFraming === 'full' ? 'head_to_toe' : 'cowboy_shot', angle: "styling" } },
                { view: "styling", pose: poseDescription || getRandomPose('random'), dynamic: true, camera: { shot_type: upperFraming === 'full' ? 'full_body' : 'cowboy_shot', framing: upperFraming === 'full' ? 'head_to_toe' : 'cowboy_shot', angle: "styling" } },
                { view: "styling_angled", pose: poseDescription || getRandomPose('angled'), dynamic: true, camera: { shot_type: upperFraming === 'full' ? 'full_body' : 'cowboy_shot', framing: upperFraming === 'full' ? 'head_to_toe' : 'cowboy_shot', angle: "styling" } },
                { view: "back", pose: "back view, straight posture", dynamic: false, camera: { shot_type: 'cowboy_shot', framing: 'cowboy_shot', angle: "back" } },
                { view: "closeup", pose: "neutral standing, looking at camera", dynamic: false, camera: { shot_type: 'close_up', framing: 'chest_and_face', angle: "front" } }
            ];
        } else {
            return [
                { view: "styling", pose: poseDescription || getRandomPose('random'), dynamic: true, camera: { shot_type: 'full_body', framing: 'head_to_toe', angle: "styling" } },
                { view: "styling_angled", pose: poseDescription || getRandomPose('angled'), dynamic: true, camera: { shot_type: 'full_body', framing: 'head_to_toe', angle: "styling" } },
                { view: "front", pose: "standing straight, arms at sides", dynamic: false, camera: { shot_type: 'full_body', framing: 'head_to_toe', angle: "front" } },
                { view: "back", pose: "standing straight, arms at sides", dynamic: false, camera: { shot_type: 'full_body', framing: 'head_to_toe', angle: "back" } },
                { view: "front_detail", pose: "standing straight, arms at sides", dynamic: false, camera: { shot_type: 'close_up', framing: 'waist_to_above_knees', angle: "front" } },
                { view: "back_detail", pose: "standing straight, arms at sides", dynamic: false, camera: { shot_type: 'close_up', framing: 'waist_to_above_knees', angle: "back" } }
            ];
        }
    };

    const handleBatchGenerate = async () => {
        if (!productCode.trim()) {
            toast.error(language === "tr" ? "√úr√ºn kodu gerekli!" : "Product code required!");
            return;
        }
        if (!assets.model) {
            toast.error(language === "tr" ? "Model g√∂rseli gerekli!" : "Model image required!");
            return;
        }

        setIsProcessing(true);

        try {
            // Analysis (same as regular generation)
            let currentProductDesc = productDescription;
            let currentFitDesc = fitDescription;
            let currentProductName = productName;

            const garmentImages: string[] = [];
            if (workflowType === 'lower') {
                if (assets.bottom_front) garmentImages.push(assets.bottom_front);
                if (assets.bottom_back) garmentImages.push(assets.bottom_back);
            } else {
                if (assets.top_front) garmentImages.push(assets.top_front);
                if (assets.top_back) garmentImages.push(assets.top_back);
            }

            if (garmentImages.length > 0 && !currentProductDesc) {
                toast.info(language === "tr" ? "√úr√ºn analizi..." : "Analyzing...");
                const res = await fetch("/api/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ images: garmentImages, type: 'fabric', language: 'en' })
                });
                const data = await res.json();
                if (data.data) {
                    if (data.data.visualPrompt) {
                        currentProductDesc = data.data.visualPrompt;
                        setProductDescription(currentProductDesc);
                    }
                    if (data.data.fitDescription) {
                        currentFitDesc = data.data.fitDescription;
                        setFitDescription(currentFitDesc);
                    }
                    if (data.data.productName && !currentProductName) {
                        currentProductName = data.data.productName;
                        setProductName(currentProductName);
                    }
                }
            }

            if (!currentProductName) currentProductName = "Fashion Garment";

            const selectedModel = savedModels.find(m => m.url === assets.model);
            const modelGender = (selectedModel?.gender || gender || "female") as 'male' | 'female';

            const batchSpecs = buildBatchSpecs(currentProductName, modelGender);
            const previews = batchSpecs.map((spec, idx) => ({
                title: `${productCode}_image_${String(idx + 1).padStart(3, '0')}`,
                spec: spec,
                structured: {
                    productName: currentProductName,
                    productDescription: currentProductDesc,
                    fitDescription: currentFitDesc,
                    pose: spec.pose,
                    view: spec.view,
                    camera: spec.camera
                }
            }));

            setBatchPreviewPrompts(previews);
            setEditedBatchPrompts(previews.map(p => JSON.stringify(p.structured, null, 2)));
            setShowBatchPreview(true);

        } catch (e: any) {
            console.error("BATCH GENERATE ERROR:", e);
            toast.error(`Error: ${e.message}`);
        } finally {
            setIsProcessing(false);
        }
    };

    const handleConfirmBatchGeneration = async () => {
        setShowBatchPreview(false);
        setIsProcessing(true);

        try {
            const generatedImages: any[] = [];

            for (let i = 0; i < batchPreviewPrompts.length; i++) {
                const preview = batchPreviewPrompts[i];
                toast.info(`${language === "tr" ? "√úretiliyor" : "Generating"} ${i + 1}/${batchPreviewPrompts.length}...`);

                const uploadedImages: any = {
                    model: assets.model,
                    background: assets.background,
                    shoes: assets.shoes
                };

                if (preview.spec.view.includes('front') || preview.spec.view === 'styling' || preview.spec.view === 'styling_angled') {
                    uploadedImages.top_front = assets.top_front;
                    uploadedImages.bottom_front = assets.bottom_front;
                }
                if (preview.spec.view.includes('back') || preview.spec.view === 'styling_angled') {
                    uploadedImages.top_back = assets.top_back;
                    uploadedImages.bottom_back = assets.bottom_back;
                }

                const res = await fetch("/api/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        productName: preview.structured.productName,
                        workflowType: workflowType,
                        uploadedImages: uploadedImages,
                        gender: gender,
                        resolution: resolution,
                        aspectRatio: aspectRatio,
                        hairBehindShoulders: hairBehindShoulders,
                        lookAtCamera: lookAtCamera,
                        buttonsOpen: buttonsOpen,
                        tucked: tucked,
                        socksType: socksType,
                        closureType: closureType,
                        productDescription: preview.structured.productDescription,
                        fitDescription: preview.structured.fitDescription,
                        poseDescription: preview.structured.pose,
                        targetView: preview.spec.view.includes('back') ? 'back' : 'front',
                        preview: false
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    const imageUrl = data.images?.[0] || data.image_url;
                    if (imageUrl) {
                        generatedImages.push({ filename: `${preview.title}.jpg`, url: imageUrl });
                    }
                }
            }

            // Generate color palette (simple SVG)
            const colorPaletteUrl = `data:image/svg+xml;base64,${btoa(`<svg width="300" height="300" xmlns="http://www.w3.org/2000/svg"><rect width="300" height="300" fill="#4A90E2"/><rect y="250" width="300" height="50" fill="rgba(0,0,0,0.6)"/><text x="150" y="275" text-anchor="middle" fill="white" font-size="16" font-weight="bold">${productCode}</text><text x="150" y="30" text-anchor="middle" fill="white" font-size="12" opacity="0.8">Color Palette</text><text x="150" y="50" text-anchor="middle" fill="white" font-size="14" font-weight="bold">#4A90E2</text></svg>`)}`;

            setBatchResultImages(generatedImages);
            setColorPalette(colorPaletteUrl);
            toast.success(language === "tr" ? "Toplu √ºretim tamamlandƒ±!" : "Batch generation complete!");

        } catch (e: any) {
            console.error("BATCH CONFIRM ERROR:", e);
            toast.error(`Error: ${e.message}`);
        } finally {
            setIsProcessing(false);
        }
    };

    const handleNewStyling = () => handleGenerate({ isReStyling: true });
    const handleThreeAngles = () => handleGenerate({ isThreeAngles: true });
    const handleUpscale = (imgUrl: string) => {
        // Navigate or show upscale modal
        toast.info(language === "tr" ? "Upscale sayfasƒ±na y√∂nlendiriliyor..." : "Navigating to Upscale...");
        // For now, simple link
        window.open(`/upscale?img=${encodeURIComponent(imgUrl)}`, '_blank');
    };


    // State for Settings
    const [resolution, setResolution] = useState("4K"); // Default 4K
    const [aspectRatio, setAspectRatio] = useState("2:3"); // Default 2:3
    const [gender, setGender] = useState<string>(""); // "" = Unspecified, "male", "female"
    // hasOwnOutfit removed as per user request to always show all options
    // const [hasOwnOutfit, setHasOwnOutfit] = useState(false)
    const [isAccessoriesOpen, setIsAccessoriesOpen] = useState(false); // Toggle for simple/advanced mode

    // State for Library Drawer
    const [activeLibraryAsset, setActiveLibraryAsset] = useState<string | null>(null);
    const [activeGroup, setActiveGroup] = useState<'product' | 'accessories' | null>(null);
    const [internalAsset, setInternalAsset] = useState<string | null>(null);
    const [libraryTab, setLibraryTab] = useState("templates");
    const [sessionLibrary, setSessionLibrary] = useState<string[]>([]);

    // LIBRARY STATES
    const [savedPoses, setSavedPoses] = useState<SavedPose[]>([]);
    const [savedModels, setSavedModels] = useState<SavedModel[]>([]);
    const [savedBackgrounds, setSavedBackgrounds] = useState<SavedBackground[]>([]);
    const [savedFits, setSavedFits] = useState<SavedFit[]>([]);
    const [savedShoes, setSavedShoes] = useState<SavedShoe[]>([]);

    // Dialog States
    const [showSavePoseDialog, setShowSavePoseDialog] = useState(false);
    const [showSaveModelDialog, setShowSaveModelDialog] = useState(false);
    const [showSaveAssetDialog, setShowSaveAssetDialog] = useState(false);

    // Temp Data for Saving
    const [tempPoseData, setTempPoseData] = useState<{ original: string, stickman: string } | null>(null);
    const [tempModelData, setTempModelData] = useState<{ url: string, name: string, gender: 'male' | 'female' } | null>(null);
    const [tempAssetData, setTempAssetData] = useState<{ key: string, url: string, name: string } | null>(null);

    // Edit Thumbnail State
    const [editingThumbItem, setEditingThumbItem] = useState<{ type: string, id: string } | null>(null);
    const [editingItemPrompt, setEditingItemPrompt] = useState(""); // New: State for custom prompt editing

    // LOAD LIBRARIES from IndexedDB (with migration check)
    useEffect(() => {
        const loadLibraries = async () => {
            // First run migration if needed
            await dbOperations.migrateFromLocalStorage();

            // Load all stores
            try {
                const poses = await dbOperations.getAll<SavedPose>(STORES.POSES);
                setSavedPoses(poses.sort((a, b) => b.createdAt - a.createdAt));

                const models = await dbOperations.getAll<SavedModel>(STORES.MODELS);
                setSavedModels(models.sort((a, b) => b.createdAt - a.createdAt));

                const bgs = await dbOperations.getAll<SavedBackground>(STORES.BACKGROUNDS);
                setSavedBackgrounds(bgs.sort((a, b) => b.createdAt - a.createdAt));

                const fits = await dbOperations.getAll<SavedFit>(STORES.FITS);
                setSavedFits(fits.sort((a, b) => b.createdAt - a.createdAt));

                const shoes = await dbOperations.getAll<SavedShoe>(STORES.SHOES);
                setSavedShoes(shoes.sort((a, b) => b.createdAt - a.createdAt));

            } catch (e) {
                console.error("Failed to load libraries form DB", e);
                // Fallback to empty/default is handled by initial state
            }
        };

        loadLibraries();
    }, []);

    // POSE HANDLERS
    const handleSavePose = async (genderValue: 'male' | 'female' | 'skip') => {
        if (!tempPoseData) return;
        setShowSavePoseDialog(false);
        try {
            toast.info(language === "tr" ? "Stickman olu≈üturuluyor..." : "Converting to Stickman...");
            const res = await fetch("/api/pose", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ image_url: tempPoseData.original })
            });
            if (!res.ok) throw new Error("Stickman conversion failed");
            const data = await res.json();
            const stickmanUrl = data.pose_image;
            setPoseStickman(stickmanUrl);

            // Pose analysis is now disabled. 
            // The pose will be saved without automatic description.
            // analyzePose(tempPoseData.original);

            if (genderValue !== 'skip') {
                const optimizedThumb = await resizeImageToThumbnail(tempPoseData.original);
                const newPose: SavedPose = {
                    id: crypto.randomUUID(),
                    url: tempPoseData.original,
                    name: language === "tr" ? "Yeni Poz" : "New Pose",
                    thumbUrl: optimizedThumb,
                    originalThumb: optimizedThumb,
                    stickmanUrl: stickmanUrl,
                    gender: genderValue,
                    createdAt: Date.now()
                };
                const updated = [newPose, ...savedPoses];
                setSavedPoses(updated);
                await dbOperations.add(STORES.POSES, newPose);
                toast.success(language === "tr" ? "Poz k√ºt√ºphaneye kaydedildi" : "Pose saved to library");
            }
            setTempPoseData(null);
        } catch (e) {
            console.error(e);
            toast.error("Failed to convert/save pose");
        }
    };

    const deleteSavedPose = async (id: string) => {
        const updated = savedPoses.filter(p => p.id !== id);
        setSavedPoses(updated);
        await dbOperations.delete(STORES.POSES, id);
        toast.info(language === "tr" ? "Poz silindi" : "Pose deleted");
    };

    // MODEL HANDLERS
    const handleSaveModel = async () => {
        if (!tempModelData) return;
        const newModel: SavedModel = {
            id: crypto.randomUUID(),
            url: tempModelData.url,
            name: tempModelData.name || (language === "tr" ? "Yeni Model" : "New Model"),
            gender: tempModelData.gender,
            thumbUrl: tempModelData.url,
            createdAt: Date.now()
        };
        const updated = [newModel, ...savedModels];
        setSavedModels(updated);
        await dbOperations.add(STORES.MODELS, newModel);
        toast.success(language === "tr" ? "Model k√ºt√ºphaneye kaydedildi" : "Model saved to library");
        setAssets(prev => ({ ...prev, model: newModel.url }));
        setGender(newModel.gender);
        setTempModelData(null);
        setShowSaveModelDialog(false);
    };

    const deleteSavedModel = async (id: string) => {
        const updated = savedModels.filter(m => m.id !== id);
        setSavedModels(updated);
        await dbOperations.delete(STORES.MODELS, id);
        toast.info(language === "tr" ? "Model silindi" : "Model deleted");
    };

    // GENERIC ASSET HANDLERS
    const handleSaveAsset = async () => {
        if (!tempAssetData) return;
        const { key, url, name } = tempAssetData;
        const newItem: LibraryItem = {
            id: crypto.randomUUID(),
            url,
            name: name || (language === "tr" ? "Yeni √ñƒüe" : "New Item"),
            thumbUrl: url,
            createdAt: Date.now()
        };

        if (key === 'background') {
            const updated = [newItem as SavedBackground, ...savedBackgrounds];
            setSavedBackgrounds(updated);
            await dbOperations.add(STORES.BACKGROUNDS, newItem);
        } else if (key === 'fit_pattern') {
            const updated = [newItem as SavedFit, ...savedFits];
            setSavedFits(updated);
            await dbOperations.add(STORES.FITS, newItem);
        } else if (key === 'shoes') {
            const updated = [newItem as SavedShoe, ...savedShoes];
            setSavedShoes(updated);
            await dbOperations.add(STORES.SHOES, newItem);
        }

        toast.success(language === "tr" ? "√ñƒüe k√ºt√ºphaneye kaydedildi" : "Item saved to library");
        setAssets(prev => ({ ...prev, [key]: url }));
        setTempAssetData(null);
        setShowSaveAssetDialog(false);
    };

    const deleteSavedAsset = async (key: string, id: string) => {
        if (key === 'background') {
            const updated = savedBackgrounds.filter(i => i.id !== id);
            setSavedBackgrounds(updated);
            await dbOperations.delete(STORES.BACKGROUNDS, id);
        } else if (key === 'fit_pattern') {
            const updated = savedFits.filter(i => i.id !== id);
            setSavedFits(updated);
            await dbOperations.delete(STORES.FITS, id);
        } else if (key === 'shoes') {
            const updated = savedShoes.filter(i => i.id !== id);
            setSavedShoes(updated);
            await dbOperations.delete(STORES.SHOES, id);
        }
        toast.info(language === "tr" ? "√ñƒüe silindi" : "Item deleted");
    };

    // THUMBNAIL UPDATE HANDLER
    const handleUpdateThumbnail = async (file: File | null) => {
        if (!editingThumbItem) return;
        const { type, id } = editingThumbItem;
        try {
            let resizedThumb = "";
            if (file) {
                resizedThumb = await resizeImageToThumbnail(await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target?.result as string);
                    reader.readAsDataURL(file);
                }));
            }

            if (type === 'pose') {
                const updated = savedPoses.map(item => item.id === id ? { ...item, thumbUrl: resizedThumb || item.thumbUrl, customPrompt: editingItemPrompt } : item);
                const itemToUpdate = updated.find(i => i.id === id);
                setSavedPoses(updated);
                if (itemToUpdate) {
                    await dbOperations.add(STORES.POSES, itemToUpdate);
                    // Proactively update current session if this is the active pose
                    if (assets.pose === itemToUpdate.stickmanUrl) {
                        setPoseDescription(editingItemPrompt);
                    }
                }
            } else if (type === 'model') {
                const updated = savedModels.map(item => item.id === id ? { ...item, thumbUrl: resizedThumb || item.thumbUrl } : item);
                const itemToUpdate = updated.find(i => i.id === id);
                setSavedModels(updated);
                if (itemToUpdate) await dbOperations.add(STORES.MODELS, itemToUpdate);
            } else if (type === 'background') {
                const updated = savedBackgrounds.map(item => item.id === id ? { ...item, thumbUrl: resizedThumb || item.thumbUrl } : item);
                const itemToUpdate = updated.find(i => i.id === id);
                setSavedBackgrounds(updated);
                if (itemToUpdate) await dbOperations.add(STORES.BACKGROUNDS, itemToUpdate);
            } else if (type === 'fit_pattern') {
                const updated = savedFits.map(item => item.id === id ? { ...item, thumbUrl: resizedThumb || item.thumbUrl, customPrompt: editingItemPrompt } : item);
                const itemToUpdate = updated.find(i => i.id === id);
                setSavedFits(updated);
                if (itemToUpdate) {
                    await dbOperations.add(STORES.FITS, itemToUpdate);
                    // Proactively update current session if this is the active fit
                    if (assets.fit_pattern === itemToUpdate.url) {
                        setFitDescription(editingItemPrompt);
                    }
                }
            } else if (type === 'shoes') {
                const updated = savedShoes.map(item => item.id === id ? { ...item, thumbUrl: resizedThumb || item.thumbUrl } : item);
                const itemToUpdate = updated.find(i => i.id === id);
                setSavedShoes(updated);
                if (itemToUpdate) await dbOperations.add(STORES.SHOES, itemToUpdate);
            }
            toast.success(language === "tr" ? "G√ºncellendi" : "Updated");
            setEditingThumbItem(null);
            setEditingItemPrompt("");
        } catch (e) {
            console.error(e);
            toast.error("Update failed");
        }
    };

    // Sync internal asset for animation persistence
    useEffect(() => {
        if (activeLibraryAsset) setInternalAsset(activeLibraryAsset);
        // Reset tab to library appropriately
        if (activeLibraryAsset) {
            setLibraryTab("library");
        }
    }, [activeLibraryAsset]);


    // Library Filter States (Mock)
    const [filterAge, setFilterAge] = useState("All");
    const [filterGender, setFilterGender] = useState("All");
    const [filterEthnicity, setFilterEthnicity] = useState("All");

    // library items mapping
    const getLibraryItems = (assetKey: string) => {
        if (assetKey === 'model') return savedModels.map(m => ({ id: m.id, src: m.url, label: m.name }));
        if (assetKey === 'background') return BACKGROUND_PRESETS.map(b => ({ id: b.id, src: b.preview!, label: language === "tr" ? b.labelTr : b.label }));
        if (assetKey === 'pose') return POSE_PRESETS.map(p => ({ id: p.id, src: p.preview, icon: p.icon, label: language === "tr" ? p.labelTr : p.label }));
        return [];
    };

    const [stylingIteration, setStylingIteration] = useState(0);

    const handleLibrarySelect = (item: any, isUpload: boolean = false) => {
        if (!activeLibraryAsset) return;

        // Add to session library if uploaded and not already full
        if (isUpload && item.src) {
            if (!sessionLibrary.includes(item.src)) {
                // Add to library up to 3 for free (mock limit), but we allow adding more as per "Upgrade" text logic?
                // The requirement: "K√ºt√ºphane max 3 g√∂rsel kaydedilen bir alan olmalƒ±."
                // Unlimited storage for local app
                setSessionLibrary(prev => [item.src, ...prev]);
            }
        }

        if (item.src) {
            setAssets(prev => ({ ...prev, [activeLibraryAsset]: item.src }));
        } else if (item.icon) {
            // For poses, we might store the icon or a specific ID
            setAssets(prev => ({ ...prev, [activeLibraryAsset]: item.id }));
        }

        // RESET DESCRIPTIONS to prevent stale analysis
        if (activeLibraryAsset === 'pose') setPoseDescription(null);
        if (activeLibraryAsset === 'main_product' || activeLibraryAsset === 'top_front' || activeLibraryAsset === 'bottom_front') setProductDescription(null);
        if (activeLibraryAsset === 'fit_pattern') setFitDescription(null);

        // Logic for navigation after selection - REMOVED so it stays open
        // User request: "X e basmadan ... kaybolmasƒ±n geri gitmesin"
        // We do nothing here, letting the user manually Close (X) or Go Back.
    };

    const handleEditItemClick = (type: string, id: string) => {
        setEditingThumbItem({ type, id });
        if (type === 'pose') {
            const pose = savedPoses.find(p => p.id === id);
            setEditingItemPrompt(pose?.customPrompt || "");
        } else if (type === 'fit_pattern') {
            const fit = savedFits.find(f => f.id === id);
            setEditingItemPrompt(fit?.customPrompt || "");
        } else {
            setEditingItemPrompt("");
        }
    };

    const handleSavedFitClick = (fit: SavedFit) => {
        setAssets(prev => ({ ...prev, fit_pattern: fit.url }));
        if (fit.customPrompt) {
            setFitDescription(fit.customPrompt);
        } else {
            // If no custom prompt, analysis will happen during generation or manually
            setFitDescription(null);
        }
    };

    const handleSavedPoseClick = (pose: SavedPose) => {
        setAssets(prev => ({ ...prev, pose: pose.stickmanUrl }));
        setPoseStickman(pose.stickmanUrl);

        if (pose.customPrompt) {
            setPoseDescription(pose.customPrompt);
        } else {
            // Pose analysis is disabled. Keep as null.
            setPoseDescription(null);
        }
    };

    const handleAssetRemove = (id: string, e: React.MouseEvent) => {
        e.stopPropagation();
        removeAsset(id);
    };

    // Click outside handler for Library Drawer
    // Click outside handler Removed as requested to only close with X or Back
    // const drawerRef = useRef<HTMLDivElement>(null);
    // useEffect(() => {...}, [activeLibraryAsset]);

    // FORCE TAB SELECTION when asset changes
    useEffect(() => {
        // Always default to library for all assets including model/pose
        if (internalAsset) {
            setLibraryTab('library');
        }
    }, [activeLibraryAsset, activeGroup]);

    {/* Updated AssetCard: Split Interaction (Direct Upload vs Library) */ }
    const AssetCard = ({ id, label, icon: Icon, required = false }: { id: string, label: string, icon: any, required?: boolean }) => {
        const fileInputRef = useRef<HTMLInputElement>(null);

        const handleDirectUploadClick = (e: React.MouseEvent) => {
            e.stopPropagation();
            fileInputRef.current?.click();
        };

        const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
            if (e.target.files && e.target.files[0]) {
                handleAssetUpload(id, e.target.files[0]);
            }
        };

        return (
            <div
                className={`asset-card-trigger relative group h-14 rounded-lg border flex items-center gap-0 overflow-hidden transition-all
                ${assets[id] ? 'border-violet-500 bg-violet-50/10' : 'border-border hover:border-violet-400 hover:bg-muted/50'}
                ${required && !assets[id] ? 'ring-1 ring-red-400/50' : ''}
                ${activeLibraryAsset === id ? 'ring-2 ring-violet-500 border-violet-500 bg-violet-50/20' : ''}
            `}
            >
                {/* Hidden File Input */}
                <input
                    type="file"
                    accept="image/*"
                    ref={fileInputRef}
                    className="hidden"
                    onChange={handleFileChange}
                />

                {/* LEFT: Direct Upload / Preview Area */}
                <div
                    className="h-full w-14 flex items-center justify-center border-r bg-muted/30 cursor-pointer hover:bg-violet-100 dark:hover:bg-violet-900/40 transition-colors relative"
                    onClick={handleDirectUploadClick}
                    title={language === "tr" ? "Direkt Y√ºkle" : "Direct Upload"}
                >
                    {assets[id] ? (
                        <>
                            {/* Preview Image */}
                            {assets[id]?.startsWith("data:") || assets[id]?.startsWith("http") || assets[id]?.startsWith("blob:") ? (
                                <img src={assets[id]!} className="w-full h-full object-cover" />
                            ) : (
                                <Icon className="w-5 h-5 text-violet-600" />
                            )}
                            {/* Hover Edit Overlay */}
                            <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                <Upload className="w-4 h-4 text-white" />
                            </div>
                        </>
                    ) : (
                        <Upload className="w-5 h-5 text-muted-foreground group-hover:text-violet-600" />
                    )}
                </div>

                {/* RIGHT: Library / Label Area */}
                <div
                    className="flex-1 h-full flex items-center justify-between px-3 cursor-pointer"
                    onClick={(e) => {
                        e.stopPropagation();
                        setActiveLibraryAsset(activeLibraryAsset === id ? null : id);
                    }}
                >
                    <div className="flex flex-col">
                        <span className="text-xs font-medium text-foreground truncate">{label}</span>
                        {assets[id] && <span className="text-[10px] text-violet-500 font-medium">{language === "tr" ? "Se√ßildi" : "Selected"}</span>}
                    </div>

                    <div className="flex items-center gap-1">
                        {/* Stickman Button for Pose */}
                        {id === 'pose' && assets[id] && !assets[id]?.includes('fal.media') && (
                            <button
                                onClick={(e) => {
                                    e.stopPropagation();
                                    convertToStickman();
                                }}
                                className="text-muted-foreground hover:text-violet-500 transition-colors p-1"
                                title={language === "tr" ? "√á√∂p Adam'a (Stickman) √áevir" : "Convert to Stickman"}
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="lucide lucide-person-standing"><circle cx="12" cy="5" r="1" /><path d="m9 20 3-6 3 6" /><path d="m6 8 6 2 6-2" /><path d="M12 10v4" /></svg>
                            </button>
                        )}

                        {assets[id] ? (
                            <button
                                onClick={(e) => handleAssetRemove(id, e)}
                                className="text-muted-foreground hover:text-red-500 transition-colors p-1"
                                title={language === "tr" ? "Kaldƒ±r" : "Remove"}
                            >
                                <Trash2 className="w-4 h-4" />
                            </button>
                        ) : (
                            <>
                                {required && <span className="text-[10px] text-red-500 font-bold">*</span>}
                                <ChevronRight className="w-4 h-4 text-muted-foreground opacity-50" />
                            </>
                        )}
                    </div>
                </div>
            </div>
        );
    };

    if (!mounted) return null;

    return (
        <div className="flex flex-col lg:flex-row h-auto lg:h-[calc(100vh-64px)] overflow-hidden relative">

            {/* Library Sidebar (Expanded Slide-out) */}
            <div
                // ref={drawerRef} // Ref removed
                className={`absolute left-[420px] top-0 bottom-0 w-80 bg-background border-r shadow-2xl z-10 flex flex-col transition-all duration-300 ease-in-out
                    ${activeLibraryAsset ? 'translate-x-0 opacity-100' : 'translate-x-[-100%] opacity-0 pointer-events-none'}
                `}
            >
                {/* Header */}
                <div className="p-3 border-b flex items-center justify-between bg-muted/30">
                    <div className="flex items-center gap-2">
                        {/* Back Button for Nested Navigation */}
                        {(activeLibraryAsset && !['product_group', 'accessories_group'].includes(activeLibraryAsset) && activeGroup) && (
                            <Button
                                variant="ghost"
                                size="icon"
                                className="h-6 w-6 -ml-1 mr-1"
                                onClick={() => setActiveLibraryAsset(activeGroup === 'product' ? 'product_group' : 'accessories_group')}
                            >
                                <ChevronLeft className="w-4 h-4" />
                            </Button>
                        )}

                        <span className="text-sm font-bold truncate max-w-[150px]">
                            {activeLibraryAsset === 'product_group' ? (language === "tr" ? "√úr√ºn" : "Product") :
                                activeLibraryAsset === 'accessories_group' ? (language === "tr" ? "Aksesuarlar" : "Accessories") :
                                    (language === "tr" ? "Se√ßim Yap" : "Select Asset")}
                        </span>
                        {/* Removed Group Badge as requested */}
                    </div>
                    <Button variant="ghost" size="icon" className="h-6 w-6" onClick={() => { setActiveLibraryAsset(null); setActiveGroup(null); }}>
                        <X className="w-4 h-4" />
                    </Button>
                </div>

                {/* GROUP SELECTION VIEW */}
                {(activeLibraryAsset === 'product_group' || activeLibraryAsset === 'accessories_group') ? (
                    <div className="flex-1 overflow-y-auto p-3 space-y-2">
                        {activeLibraryAsset === 'product_group' && (
                            <>
                                <AssetCard id="top_front" label={language === "tr" ? "√úst √úr√ºn √ñn Kare" : "Top Front"} icon={FileText} />
                                <AssetCard id="top_back" label={language === "tr" ? "√úst √úr√ºn Arka Kare" : "Top Back"} icon={MoveHorizontal} />
                                <AssetCard id="bottom_front" label={language === "tr" ? "Alt √úr√ºn √ñn Kare" : "Bottom Front"} icon={FileText} />
                                <AssetCard id="bottom_back" label={language === "tr" ? "Alt √úr√ºn Arka Kare" : "Bottom Back"} icon={MoveHorizontal} />
                                <div className="my-2 border-t" />
                                <AssetCard id="inner_wear" label={language === "tr" ? "ƒ∞√ß Giyim (Opsiyonel)" : "Inner Wear (Optional)"} icon={Shirt} />
                                <div className="my-2 border-t" />
                                <h4 className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider mb-2">{language === "tr" ? "Detaylar" : "Details"}</h4>
                                <AssetCard id="detail_1" label={language === "tr" ? "Detay 1 (Kuma≈ü/Doku)" : "Detail 1 (Fabric)"} icon={ScanLine} />
                                <AssetCard id="detail_2" label={language === "tr" ? "Detay 2 (Diki≈ü/Kesim)" : "Detail 2 (Stitching)"} icon={Scissors} />
                                <AssetCard id="detail_3" label={language === "tr" ? "Detay 3 (Ek √ñzellik)" : "Detail 3 (Extra)"} icon={Maximize2} />

                            </>
                        )}

                        {activeLibraryAsset === 'accessories_group' && (
                            <>
                                <AssetCard id="jacket" label={language === "tr" ? "Dƒ±≈ü Giyim" : "Outerwear"} icon={Shirt} />
                                <AssetCard id="bag" label={language === "tr" ? "√áanta" : "Bag"} icon={ShoppingBag} />
                                <AssetCard id="glasses" label={language === "tr" ? "G√∂zl√ºk" : "Glasses"} icon={Glasses} />
                                <AssetCard id="hat" label={language === "tr" ? "≈ûapka" : "Hat"} icon={Sparkles} />
                                <AssetCard id="jewelry" label={language === "tr" ? "Takƒ±" : "Jewelry"} icon={Gem} />
                                {tucked && <AssetCard id="belt" label={language === "tr" ? "Kemer" : "Belt"} icon={ScanLine} />}
                            </>
                        )}
                    </div>
                ) : (
                    /* NORMAL LIBRARY VIEW */
                    <div className="flex-1 flex flex-col overflow-hidden">

                        {/* POSE FOCUS TOGGLE (Only for Pose) */}
                        {/* POSE FOCUS TOGGLE (Only for Pose) */}
                        {internalAsset === 'pose' && (
                            <div className="px-3 py-2 border-b bg-muted/20 flex items-center justify-between">
                                <span className="text-xs font-medium text-muted-foreground">{language === "tr" ? "Odak Alanƒ±" : "Focus Area"}</span>
                                <div className="flex items-center gap-2 bg-muted p-1 rounded-lg">
                                    <button
                                        onClick={() => setPoseFocus('full')}
                                        className={`text-[10px] px-2 py-1 rounded-md transition-all ${poseFocus === 'full' ? 'bg-background shadow text-foreground font-bold' : 'text-muted-foreground hover:text-foreground'}`}
                                    >
                                        {language === "tr" ? "Tam Boy" : "Full Body"}
                                    </button>
                                    <button
                                        onClick={() => setPoseFocus('upper')}
                                        className={`text-[10px] px-2 py-1 rounded-md transition-all ${poseFocus === 'upper' ? 'bg-background shadow text-foreground font-bold' : 'text-muted-foreground hover:text-foreground'}`}
                                    >
                                        {language === "tr" ? "√úst Beden" : "Upper Body"}
                                    </button>
                                </div>
                            </div>
                        )}

                        <Tabs value={libraryTab} onValueChange={setLibraryTab} className="flex-1 flex flex-col">
                            <div className="px-3 pt-3">
                                <TabsList className="w-full grid grid-cols-3">
                                    {/* POSE & MODEL Share the same "Library | Upload" structure */}
                                    {['pose', 'model'].includes(internalAsset || "") ? (
                                        <>
                                            <TabsTrigger value="library" className="text-xs col-span-2">{language === "tr" ? "K√ºt√ºphane" : "Library"}</TabsTrigger>
                                            <TabsTrigger value="assets" className="text-xs col-span-1">{language === "tr" ? "Y√ºkle" : "Upload"}</TabsTrigger>
                                        </>
                                    ) : (
                                        /* Standard or other custom tabs */
                                        <>
                                            <TabsTrigger value="library" className="text-xs col-span-1">{language === "tr" ? "K√ºt√ºphane" : "Library"}</TabsTrigger>
                                            <TabsTrigger value="assets" className="text-xs col-span-2">{language === "tr" ? "Y√ºkle" : "Upload"}</TabsTrigger>
                                        </>
                                    )}
                                </TabsList>
                            </div>

                            {/* TAB: LIBRARY */}
                            <TabsContent value="library" className="flex-1 overflow-y-auto p-3 space-y-4">
                                {internalAsset === 'pose' ? (
                                    <div className="space-y-4">
                                        {['female', 'male'].map(g => (
                                            <div key={g} className="space-y-2">
                                                <h4 className="text-[10px] uppercase font-bold text-muted-foreground flex items-center gap-2">
                                                    <User size={12} className={g === 'female' ? 'text-pink-500' : 'text-blue-500'} />
                                                    {g === 'female' ? "Female Poses" : "Male Poses"}
                                                </h4>
                                                <div className="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                                    {savedPoses.filter(p => p.gender === g).map(pose => (
                                                        <div key={pose.id} className="group relative aspect-[2/3] rounded-lg border bg-card overflow-hidden cursor-pointer hover:ring-2 hover:ring-violet-500 transition-all shrink-0">
                                                            <img src={pose.thumbUrl || pose.originalThumb} className="w-full h-full object-cover" onClick={() => handleSavedPoseClick(pose)} />
                                                            <div className="absolute top-1 right-1 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={(e) => { e.stopPropagation(); deleteSavedPose(pose.id); }} className="p-1 bg-red-500 text-white rounded hover:bg-red-600"><X size={10} /></button>
                                                                <button onClick={(e) => { e.stopPropagation(); handleEditItemClick('pose', pose.id); }} className="p-1 bg-violet-500 text-white rounded hover:bg-violet-600"><Edit2 size={10} /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : internalAsset === 'model' ? (
                                    <div className="space-y-4">
                                        {['female', 'male'].map(g => (
                                            <div key={g} className="space-y-2">
                                                <h4 className="text-[10px] uppercase font-bold text-muted-foreground flex items-center gap-2">
                                                    <User size={12} className={g === 'female' ? 'text-pink-500' : 'text-blue-500'} />
                                                    {g === 'female' ? "Female Models" : "Male Models"}
                                                </h4>
                                                <div className="grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                                    {savedModels.filter(m => m.gender === g).map(model => (
                                                        <div key={model.id} className="group relative aspect-[2/3] rounded-lg border bg-card overflow-hidden cursor-pointer hover:ring-2 hover:ring-violet-500 transition-all shrink-0">
                                                            <img src={model.thumbUrl || model.url} className="w-full h-full object-cover" onClick={() => { setAssets(p => ({ ...p, model: model.url })); setGender(model.gender); setActiveLibraryAsset(null); }} />
                                                            <div className="absolute bottom-0 inset-x-0 p-1 bg-black/60 text-[9px] text-white truncate">{model.name}</div>
                                                            <div className="absolute top-1 right-1 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={(e) => { e.stopPropagation(); deleteSavedModel(model.id); }} className="p-1 bg-red-500 text-white rounded hover:bg-red-600"><X size={10} /></button>
                                                                <button onClick={(e) => { e.stopPropagation(); handleEditItemClick('model', model.id); }} className="p-1 bg-violet-500 text-white rounded hover:bg-violet-600"><Edit2 size={10} /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (['background', 'fit_pattern', 'shoes'].includes(internalAsset || '')) ? (
                                    <div className="space-y-4">
                                        <div className="grid grid-cols-2 gap-2">
                                            {(internalAsset === 'background' ? savedBackgrounds : internalAsset === 'fit_pattern' ? savedFits : savedShoes).map(item => (
                                                <div key={item.id} className="group relative aspect-square rounded-lg border bg-card overflow-hidden cursor-pointer hover:ring-2 hover:ring-violet-500 transition-all">
                                                    <img
                                                        src={item.thumbUrl || item.url}
                                                        className="w-full h-full object-cover"
                                                        onClick={() => {
                                                            if (internalAsset === 'fit_pattern') {
                                                                handleSavedFitClick(item as SavedFit);
                                                            } else {
                                                                setAssets(p => ({ ...p, [internalAsset!]: item.url }));
                                                            }
                                                            setActiveLibraryAsset(null);
                                                        }}
                                                    />
                                                    <div className="absolute bottom-0 inset-x-0 p-1 bg-black/60 text-[9px] text-white truncate">{item.name}</div>
                                                    <div className="absolute top-1 right-1 flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                        <button onClick={(e) => { e.stopPropagation(); deleteSavedAsset(internalAsset!, item.id); }} className="p-1 bg-red-500 text-white rounded hover:bg-red-600"><X size={10} /></button>
                                                        <button onClick={(e) => { e.stopPropagation(); handleEditItemClick(internalAsset!, item.id); }} className="p-1 bg-violet-500 text-white rounded hover:bg-violet-600"><Edit2 size={10} /></button>
                                                    </div>
                                                </div>
                                            ))}
                                            {(internalAsset === 'background' ? savedBackgrounds : internalAsset === 'fit_pattern' ? savedFits : savedShoes).length === 0 && (
                                                <div className="col-span-2 text-center text-[10px] text-muted-foreground py-10 bg-muted/20 border border-dashed rounded-lg">No saved items.</div>
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-2 gap-2">
                                        {sessionLibrary.map((item, idx) => (
                                            <div key={idx} onClick={() => handleLibrarySelect({ src: item })} className="aspect-[3/4] rounded-lg border bg-muted overflow-hidden cursor-pointer hover:ring-2 hover:ring-violet-500 transition-all">
                                                <img src={item} className="w-full h-full object-cover" />
                                            </div>
                                        ))}
                                    </div>
                                )}


                            </TabsContent>

                            <TabsContent value="templates" className="flex-1 overflow-y-auto p-3 space-y-4">
                                {internalAsset === 'model' && (
                                    <div className="grid grid-cols-2 gap-2 text-center py-10 text-xs text-muted-foreground">
                                        {language === "tr" ? "L√ºtfen K√ºt√ºphaneyi kullanƒ±n." : "Please use the Library."}
                                    </div>
                                )}
                            </TabsContent>

                            <TabsContent value="prompt" className="flex-1 p-3">
                                <div className="space-y-2">
                                    <label className="text-xs font-medium">{language === "tr" ? "√ñzel ƒ∞stem" : "Custom Prompt"}</label>
                                    <textarea
                                        className="w-full h-32 p-2 text-xs rounded-lg border bg-background resize-none focus:ring-1 focus:ring-violet-500"
                                        placeholder={language === "tr" ? "Tam olarak ne istediƒüinizi tarif edin..." : "Describe exactly what you want..."}
                                    ></textarea>
                                    <Button size="sm" className="w-full text-xs">{language === "tr" ? "ƒ∞stemi Uygula" : "Apply Prompt"}</Button>
                                    <p className="text-[10px] text-muted-foreground mt-2">
                                        {language === "tr" ? "Bu varlƒ±k i√ßin √∂zel prompt kullanƒ±n." : "Use a custom prompt for this asset slot."}
                                    </p>
                                </div>
                            </TabsContent>

                            <TabsContent value="assets" className="flex-1 overflow-y-auto p-3 space-y-4">
                                <div className="border-2 border-dashed border-muted-foreground/20 rounded-xl p-4 flex flex-col items-center justify-center gap-2 cursor-pointer hover:bg-muted/30 hover:border-violet-500/50 transition-all relative">
                                    <input
                                        type="file"
                                        className="absolute inset-0 opacity-0 cursor-pointer"
                                        onChange={(e) => {
                                            const file = e.target.files?.[0];
                                            if (file) {
                                                const reader = new FileReader();
                                                reader.onloadend = () => {
                                                    handleLibrarySelect({ src: reader.result as string }, true);
                                                };
                                                reader.readAsDataURL(file);
                                            }
                                        }}
                                    />
                                    <div className="p-3 bg-violet-100 dark:bg-violet-900/20 rounded-full">
                                        <Upload className="w-5 h-5 text-violet-600 dark:text-violet-400" />
                                    </div>
                                    <div className="text-center">
                                        <p className="text-xs font-medium">{language === "tr" ? "Y√ºklemek i√ßin Tƒ±kla" : "Click to Upload"}</p>
                                        <p className="text-[10px] text-muted-foreground">{language === "tr" ? "veya s√ºr√ºkleyip bƒ±rak" : "or drag and drop"}</p>
                                    </div>
                                </div>

                                {(internalAsset === 'model' || internalAsset === 'pose') && (
                                    <div className="space-y-2">
                                        <h4 className="text-xs font-semibold uppercase tracking-wider text-muted-foreground">
                                            {language === "tr" ? "Eƒüitilmi≈ü Modellerim" : "My Trained Models"}
                                        </h4>
                                        <div className="grid grid-cols-2 gap-2">
                                            {models.map(model => (
                                                <div
                                                    key={model.id}
                                                    onClick={() => {
                                                        if (model.thumbnailUrl) {
                                                            setAssets(prev => ({ ...prev, [internalAsset!]: model.thumbnailUrl as string }));
                                                        }
                                                        setActiveLibraryAsset(null);
                                                    }}
                                                    className="aspect-square rounded-lg border bg-muted overflow-hidden relative cursor-pointer hover:ring-2 hover:ring-violet-500"
                                                >
                                                    {model.thumbnailUrl ? (
                                                        <img src={model.thumbnailUrl} className="w-full h-full object-cover" />
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center bg-violet-100 text-violet-600 font-bold text-xs p-2 text-center">
                                                            {model.name}
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </TabsContent>
                        </Tabs>
                    </div>
                )}
            </div>

            {/* COLUMN 1: Settings & Uploads (Sidebar) */}
            <div className="w-full lg:w-[420px] lg:h-full lg:border-r border-b lg:border-b-0 bg-background flex flex-col shrink-0 relative z-20 overflow-hidden">
                <div className="p-4 flex-1 overflow-y-auto custom-scrollbar space-y-6">

                    {/* Page Title */}
                    <div className="mb-4">
                        <h1 className="text-2xl font-bold">{t("home.photoshootTitle")}</h1>
                        <p className="text-sm text-muted-foreground">{t("home.photoshootDesc")}</p>
                    </div>

                    {/* 1. Product Context & Settings */}
                    <div className="space-y-4">
                        {/* Product Name */}
                        <div className="space-y-4 mb-4">
                            {/* Product Type Selector */}
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-bold text-muted-foreground">{language === "tr" ? "√úr√ºn Tipi" : "Product Type"}</label>
                                <select
                                    className="w-full text-xs p-2 rounded-lg bg-muted/30 border border-border"
                                    value={workflowType}
                                    onChange={(e) => setWorkflowType(e.target.value as any)}
                                >
                                    <option value="upper">{language === "tr" ? "√úst Giyim (Ceket, G√∂mlek, T-shirt)" : "Upper Body (Jacket, Shirt)"}</option>
                                    <option value="lower">{language === "tr" ? "Alt Giyim (Pantolon, Etek, ≈ûort)" : "Lower Body (Pants, Skirt)"}</option>
                                    <option value="dress">{language === "tr" ? "Elbise / Tulum / Kaban" : "Dress / Jumpsuit / Coat"}</option>
                                    <option value="set">{language === "tr" ? "Takƒ±m (Alt + √úst)" : "Set (Top + Bottom)"}</option>
                                </select>
                            </div>

                            {/* Product Name Input - EDITABLE */}
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-bold text-muted-foreground">{language === "tr" ? "√úr√ºn Adƒ±" : "Product Name"}</label>
                                <div className="bg-muted/30 p-2 rounded-xl ring-1 ring-border">
                                    <input
                                        type="text"
                                        value={productName}
                                        onChange={(e) => setProductName(e.target.value)}
                                        placeholder={language === "tr" ? "G√∂rsel y√ºklenince otomatik dolar" : "Auto-detected or type manually"}
                                        className="w-full bg-transparent border-none text-sm font-medium focus:ring-0 p-1 placeholder:text-muted-foreground/50"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Settings Grid (Resolution & Ratio) */}
                        <div className="space-y-1 pt-2">
                            <div className="flex items-center justify-between">
                                <label className="text-[10px] uppercase font-bold text-muted-foreground">{language === "tr" ? "Model Cinsiyeti" : "Model Gender"}</label>
                                {gender && (
                                    <button onClick={() => setGender("")} className="text-[10px] text-red-500 hover:underline">
                                        {language === "tr" ? "Sƒ±fƒ±rla" : "Reset"}
                                    </button>
                                )}
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <div
                                    onClick={() => setGender("female")}
                                    className={`cursor-pointer rounded-lg border p-2 flex items-center justify-center gap-2 transition-all ${gender === 'female' ? 'bg-violet-100 border-violet-500 text-violet-700' : 'bg-muted/30 border-transparent hover:bg-muted'}`}
                                >
                                    <span className="text-xs font-medium">{language === "tr" ? "Kadƒ±n" : "Female"}</span>
                                </div>
                                <div
                                    onClick={() => setGender("male")}
                                    className={`cursor-pointer rounded-lg border p-2 flex items-center justify-center gap-2 transition-all ${gender === 'male' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-muted/30 border-transparent hover:bg-muted'}`}
                                >
                                    <span className="text-xs font-medium">{language === "tr" ? "Erkek" : "Male"}</span>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2">
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-bold text-muted-foreground">{language === "tr" ? "√á√∂z√ºn√ºrl√ºk" : "Resolution"}</label>
                                <select
                                    className="w-full text-xs p-2 rounded-lg bg-muted/30 border border-border"
                                    value={resolution}
                                    onChange={(e) => setResolution(e.target.value)}
                                >
                                    {RESOLUTION_OPTIONS.map(opt => (
                                        <option key={opt.id} value={opt.id}>{language === "tr" ? opt.labelTr : opt.label}</option>
                                    ))}
                                </select>
                                {/* Credit Cost Display */}
                                <div className="flex items-center gap-1.5 px-1">
                                    <div className="w-1.5 h-1.5 rounded-full bg-violet-500"></div>
                                    <p className="text-[10px] font-medium text-violet-600 dark:text-violet-400">
                                        {RESOLUTION_OPTIONS.find(r => r.id === resolution)?.credits} {language === "tr" ? "Kredi" : "Credits"}
                                    </p>
                                </div>
                            </div>
                            {/* Aspect Ratio */}
                            <div className="space-y-1">
                                <label className="text-[10px] uppercase font-bold text-muted-foreground">{language === "tr" ? "En/Boy Oranƒ±" : "Aspect Ratio"}</label>
                                <select
                                    className="w-full text-xs p-2 rounded-lg bg-muted/30 border border-border"
                                    value={aspectRatio}
                                    onChange={(e) => setAspectRatio(e.target.value)}
                                >
                                    {ASPECT_RATIOS.map(opt => (
                                        <option key={opt.id} value={opt.id}>{language === "tr" ? opt.labelTr : opt.label}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* 2. Visual Assets */}
                    <div>
                        <div className="grid grid-cols-2 gap-2">
                            {/* ROW 1: Model / Product Group */}
                            <AssetCard id="model" label={language === "tr" ? "Model" : "Model"} icon={User} required />

                            <div
                                onClick={() => {
                                    setActiveLibraryAsset('product_group');
                                    setActiveGroup('product');
                                    setLibraryTab('assets');
                                }}
                                className="h-14 rounded-lg border border-dashed border-violet-300 bg-violet-50/50 hover:bg-violet-50 hover:border-violet-500 cursor-pointer flex items-center px-3 gap-3 transition-colors"
                            >
                                <div className="p-1.5 rounded-md bg-violet-100 text-violet-600">
                                    <Shirt className="w-5 h-5" />
                                </div>
                                <div className="flex-1 flex items-center justify-between">
                                    <span className="text-xs font-medium text-foreground">{language === "tr" ? "√úr√ºn" : "Product"}</span>
                                    <ChevronRight className="w-4 h-4 text-muted-foreground" />
                                </div>
                            </div>

                            {/* ROW 2: Background / Pose */}
                            <AssetCard id="background" label={language === "tr" ? "Arka Plan" : "Background"} icon={ImageIcon} />
                            <AssetCard id="pose" label={language === "tr" ? "Poz" : "Pose"} icon={User} />

                            {/* ROW 3: Shoes / Fit silhouette */}
                            <AssetCard id="shoes" label={language === "tr" ? "Ayakkabƒ±" : "Shoes"} icon={Footprints} />
                            <AssetCard id="fit_pattern" label={language === "tr" ? "Kalƒ±p / Sil√ºet" : "Fit / Silhouette"} icon={Ruler} />

                            <div className="col-span-2 space-y-2 mt-1">
                                <div
                                    onClick={() => {
                                        setActiveLibraryAsset('accessories_group');
                                        setActiveGroup('accessories');
                                        setLibraryTab('assets');
                                    }}
                                    className="h-14 rounded-lg border border-dashed border-muted-foreground/30 hover:bg-muted/30 cursor-pointer flex items-center px-3 gap-3 transition-colors"
                                >
                                    <div className="p-1.5 rounded-md bg-muted text-muted-foreground">
                                        <Gem className="w-5 h-5" />
                                    </div>
                                    <div className="flex-1 flex items-center justify-between">
                                        <span className="text-xs font-medium text-foreground">{language === "tr" ? "Aksesuarlar" : "Accessories"}</span>
                                        <ChevronRight className="w-4 h-4 text-muted-foreground" />
                                    </div>
                                </div>
                            </div>
                        </div>


                    </div>



                    {/* Framing Toggle for Styling - 4 Options */}
                    <div className="flex items-center justify-between p-3 bg-muted rounded-lg border my-3">
                        <span className="text-xs font-medium">{language === "tr" ? "Kadraj" : "Framing"}</span>
                        <div className="grid grid-cols-2 gap-1 bg-background p-1 rounded-md border">
                            <button
                                onClick={() => setPoseFocus('closeup')}
                                className={`text-[10px] px-2 py-1.5 rounded transition-all ${poseFocus === 'closeup' ? 'bg-violet-600 text-white font-medium shadow-sm' : 'text-muted-foreground hover:text-foreground'}`}
                            >
                                {language === "tr" ? "Yakƒ±n Plan" : "Close-Up"}
                            </button>
                            <button
                                onClick={() => setPoseFocus('upper')}
                                className={`text-[10px] px-2 py-1.5 rounded transition-all ${poseFocus === 'upper' ? 'bg-violet-600 text-white font-medium shadow-sm' : 'text-muted-foreground hover:text-foreground'}`}
                            >
                                {language === "tr" ? "√úst V√ºcut" : "Upper Body"}
                            </button>
                            <button
                                onClick={() => setPoseFocus('full')}
                                className={`text-[10px] px-2 py-1.5 rounded transition-all ${poseFocus === 'full' ? 'bg-violet-600 text-white font-medium shadow-sm' : 'text-muted-foreground hover:text-foreground'}`}
                            >
                                {language === "tr" ? "Tam Boy" : "Full Body"}
                            </button>
                            <button
                                onClick={() => setPoseFocus('lower')}
                                className={`text-[10px] px-2 py-1.5 rounded transition-all ${poseFocus === 'lower' ? 'bg-violet-600 text-white font-medium shadow-sm' : 'text-muted-foreground hover:text-foreground'}`}
                            >
                                {language === "tr" ? "Alt V√ºcut" : "Lower Body"}
                            </button>
                        </div>
                    </div>

                    {/* 3. Prep & Styling Controls (Hair, Cam, Closure, Tuck, Socks) */}
                    <div className="space-y-2 mt-4 pt-4 border-t border-border">
                        <label className="text-[10px] uppercase font-bold text-muted-foreground px-1">{language === "tr" ? "Hazƒ±rlƒ±k & Stiller" : "Preparation & Styles"}</label>

                        {/* Top Row: Hair & Look at camera */}
                        <div className="grid grid-cols-2 gap-2">
                            <div className="flex items-center justify-between p-2 rounded-lg bg-muted/50 border border-transparent cursor-pointer"
                                onClick={() => setHairBehindShoulders(!hairBehindShoulders)}>
                                <span className="text-[11px] font-medium">{language === "tr" ? "Sa√ß Arkada" : "Hair Behind"}</span>
                                <Switch checked={hairBehindShoulders} onCheckedChange={setHairBehindShoulders} />
                            </div>
                            <div className="flex items-center justify-between p-2 rounded-lg bg-muted/50 border border-transparent cursor-pointer"
                                onClick={() => setLookAtCamera(!lookAtCamera)}>
                                <span className="text-[11px] font-medium">{language === "tr" ? "Kameraya Bak" : "Look at Cam"}</span>
                                <Switch checked={lookAtCamera} onCheckedChange={setLookAtCamera} />
                            </div>
                        </div>

                        {/* Middle Row: Closure & Tuck */}
                        <div className="grid grid-cols-1 gap-2">
                            {closureType !== 'none' && (
                                <div className="flex items-center justify-between p-2 rounded-lg bg-muted/50 border border-transparent">
                                    <span className="text-[11px] font-medium">
                                        {closureType === 'zipper' ? (language === "tr" ? "Fermuar A√ßƒ±k" : "Zipper Open") : (language === "tr" ? "D√ºƒümeler A√ßƒ±k" : "Buttons Open")}
                                    </span>
                                    <Switch checked={buttonsOpen} onCheckedChange={setButtonsOpen} />
                                </div>
                            )}

                            <div className="flex items-center justify-between p-2 rounded-lg bg-muted/50 border border-transparent">
                                <span className="text-[11px] font-medium">{language === "tr" ? "Etek Ucu ƒ∞√ßeride" : "Tucked Hemline"}</span>
                                <Switch checked={tucked} onCheckedChange={setTucked} />
                            </div>
                        </div>

                        {/* Socks Row */}
                        <div className="space-y-1 px-1">
                            <label className="text-[10px] font-medium text-muted-foreground">{language === "tr" ? "√áorap Se√ßimi" : "Socks Selection"}</label>
                            <div className="grid grid-cols-3 gap-1 bg-muted/50 p-1 rounded-md border">
                                <button
                                    onClick={() => setSocksType('none')}
                                    className={`text-[10px] py-1 rounded transition-all ${socksType === 'none' ? 'bg-background shadow-sm font-medium' : 'text-muted-foreground'}`}
                                >
                                    {language === "tr" ? "Yok" : "None"}
                                </button>
                                <button
                                    onClick={() => setSocksType('white')}
                                    className={`text-[10px] py-1 rounded transition-all ${socksType === 'white' ? 'bg-white text-black shadow-sm font-medium' : 'text-muted-foreground'}`}
                                >
                                    {language === "tr" ? "Beyaz" : "White"}
                                </button>
                                <button
                                    onClick={() => setSocksType('black')}
                                    className={`text-[10px] py-1 rounded transition-all ${socksType === 'black' ? 'bg-black text-white shadow-sm font-medium' : 'text-muted-foreground'}`}
                                >
                                    {language === "tr" ? "Siyah" : "Black"}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* BATCH GENERATION CONTROLS (Mavi Almanya Integration) */}
                    <div className="space-y-3 mt-4 pt-4 border-t border-border">
                        <div className="flex items-center justify-between px-1">
                            <label className="text-[10px] uppercase font-bold text-blue-600">{language === "tr" ? "Toplu √úretim" : "Batch Generation"}</label>
                            <Switch checked={batchMode} onCheckedChange={setBatchMode} />
                        </div>

                        {batchMode && (
                            <div className="space-y-2 p-3 bg-blue-50/50 dark:bg-blue-950/20 rounded-lg border border-blue-200 dark:border-blue-800">
                                <div className="space-y-1">
                                    <label className="text-[10px] font-medium text-blue-600">{language === "tr" ? "√úr√ºn Kodu *" : "Product Code *"}</label>
                                    <input
                                        type="text"
                                        value={productCode}
                                        onChange={(e) => setProductCode(e.target.value.toUpperCase())}
                                        placeholder="MAVI-2024-001"
                                        className="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-blue-500"
                                    />
                                </div>

                                {workflowType === 'upper' && (
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-medium text-muted-foreground">{language === "tr" ? "√úst Kadraj" : "Upper Framing"}</label>
                                        <div className="flex bg-muted/30 p-1 rounded-lg border">
                                            <button
                                                onClick={() => setUpperFraming('full')}
                                                className={`flex-1 py-1.5 rounded-md text-xs font-medium transition-all ${upperFraming === 'full' ? 'bg-background shadow-sm text-blue-600' : 'text-muted-foreground'}`}
                                            >
                                                Full
                                            </button>
                                            <button
                                                onClick={() => setUpperFraming('medium_full')}
                                                className={`flex-1 py-1.5 rounded-md text-xs font-medium transition-all ${upperFraming === 'medium_full' ? 'bg-background shadow-sm text-blue-600' : 'text-muted-foreground'}`}
                                            >
                                                Medium
                                            </button>
                                        </div>
                                    </div>
                                )}

                                <div className="text-[10px] text-muted-foreground bg-background/50 p-2 rounded border">
                                    {workflowType === 'upper'
                                        ? (language === "tr" ? "5 g√∂rsel √ºretilecek: 2 styling + 1 angled + 1 back + 1 closeup" : "5 images will be generated: 2 styling + 1 angled + 1 back + 1 closeup")
                                        : (language === "tr" ? "6 g√∂rsel √ºretilecek: 2 styling + 2 technical + 2 detail" : "6 images will be generated: 2 styling + 2 technical + 2 detail")
                                    }
                                </div>

                                <Button
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                                    onClick={handleBatchGenerate}
                                    disabled={isProcessing || !productCode.trim()}
                                >
                                    {isProcessing ? <Loader2 className="w-4 h-4 animate-spin mr-2" /> : <Package className="w-4 h-4 mr-2" />}
                                    {language === "tr" ? "Toplu √úret" : "Batch Generate"}
                                </Button>
                            </div>
                        )}
                    </div>

                    {/* 5. Persistent Generation Settings */}
                    <div className="space-y-3 pt-2 pb-2 bg-muted/20 p-3 rounded-lg border">
                        <h3 className="text-xs font-semibold text-muted-foreground tracking-wider mb-2">
                            {language === "tr" ? "STƒ∞L AYARLARI" : "STYLE SETTINGS"}
                        </h3>
                        <div className="grid grid-cols-4 gap-2">
                            <button
                                onClick={() => handleGenerate({ isThreeAngles: true, targetView: 'front' })}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border bg-background hover:border-violet-500 hover:text-violet-600 transition-all"
                            >
                                <span className="text-[10px] font-medium text-center leading-tight">
                                    {language === "tr" ? "√ñn A√ßƒ±" : "Front"}
                                </span>
                            </button>
                            <button
                                onClick={() => handleGenerate({ isThreeAngles: true, targetView: 'side' })}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border bg-background hover:border-blue-500 hover:text-blue-600 transition-all"
                            >
                                <span className="text-[10px] font-medium text-center leading-tight">
                                    {language === "tr" ? "Yan A√ßƒ±" : "Side"}
                                </span>
                            </button>
                            <button
                                onClick={() => handleGenerate({ isThreeAngles: true, targetView: 'back' })}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border bg-background hover:border-amber-500 hover:text-amber-600 transition-all"
                            >
                                <span className="text-[10px] font-medium text-center leading-tight">
                                    {language === "tr" ? "Arka A√ßƒ±" : "Back"}
                                </span>
                            </button>
                            <button
                                onClick={() => resultImages && resultImages.length > 0 && router.push(`/resize?image=${encodeURIComponent(resultImages[0])}`)}
                                disabled={!resultImages || resultImages.length === 0}
                                className="flex flex-col items-center justify-center gap-1 p-2 rounded-lg border bg-background hover:border-emerald-500 hover:text-emerald-600 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <Maximize2 className="w-4 h-4" />
                                <span className="text-[10px] font-medium text-center leading-tight">Upscale</span>
                            </button>
                        </div>
                    </div>

                </div>

                {/* Footer Action */}
                <div className="p-4 border-t bg-background z-10">
                    <Button
                        size="lg"
                        className="w-full bg-violet-600 hover:bg-violet-700 shadow-lg shadow-violet-500/20"
                        onClick={() => handleGenerate()}
                        disabled={isProcessing}
                    >
                        {isProcessing ? (
                            <div className="flex items-center">
                                <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                <span>{language === "tr" ? "ƒ∞≈üleniyor..." : "Processing..."}</span>
                            </div>
                        ) : (
                            <>
                                <Sparkles className="w-4 h-4 mr-2" />
                                {language === "tr" ? "Fotoƒüraf √áek" : "Generate Photo"}
                            </>
                        )}
                    </Button>
                </div>
            </div>

            <div className="flex-1 bg-stone-50/50 dark:bg-stone-950/50 overflow-y-auto p-4 md:p-8 relative min-h-[400px] flex flex-col items-center">
                {isProcessing ? (
                    /* STUDIO PREPARATION OVERLAY */
                    <div className="h-full flex flex-col items-center justify-center space-y-8 my-auto w-full max-w-md">
                        {/* Studio Icon */}
                        <div className="relative">
                            <div className="absolute inset-0 bg-gradient-to-r from-violet-500/30 to-pink-500/30 rounded-full blur-xl animate-pulse"></div>
                            <div className="relative w-24 h-24 bg-gradient-to-br from-background to-card rounded-2xl shadow-2xl flex items-center justify-center border border-zinc-700">
                                <Camera className="w-10 h-10 text-white" />
                                <div className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full animate-pulse shadow-lg shadow-red-500/50"></div>
                            </div>
                        </div>

                        {/* Studio Steps */}
                        <StudioSteps language={language} />

                        {/* Progress Ring */}
                        <div className="w-full max-w-xs">
                            <div className="h-1 w-full bg-card overflow-hidden rounded-full">
                                <div
                                    className="h-full bg-gradient-to-r from-violet-600 via-pink-500 to-violet-600 rounded-full"
                                    style={{
                                        width: '100%',
                                        animation: 'shimmer 2s linear infinite',
                                        backgroundSize: '200% 100%'
                                    }}
                                ></div>
                            </div>
                        </div>
                    </div>
                ) : resultImages && resultImages.length > 0 ? (
                    <div className="w-full max-w-2xl flex flex-col gap-6">
                        {resultImages.length === 3 ? (
                            <div className="grid grid-cols-3 gap-4 w-full">
                                {resultImages.map((img, i) => (
                                    <div key={i} className="relative aspect-[2/3] rounded-xl overflow-hidden shadow-lg border bg-white group">
                                        <img src={img} className="w-full h-full object-cover" />
                                        <div className="absolute top-2 right-2 flex flex-col gap-2">
                                            <Button
                                                size="icon"
                                                className="h-8 w-8 rounded-full bg-white/80 hover:bg-white text-black backdrop-blur-md shadow-sm"
                                                onClick={() => router.push(`/resize?image=${encodeURIComponent(img)}`)}
                                                title="Upscale"
                                            >
                                                <Maximize2 className="w-3.5 h-3.5" />
                                            </Button>
                                            <Button
                                                size="icon"
                                                className="h-8 w-8 rounded-full bg-black/50 hover:bg-black/70 text-white backdrop-blur-md shadow-sm transition-all"
                                                onClick={async (e) => {
                                                    e.stopPropagation();
                                                    e.preventDefault();
                                                    const response = await fetch(img);
                                                    const blob = await response.blob();
                                                    const url = window.URL.createObjectURL(blob);
                                                    const link = document.createElement('a');
                                                    link.href = url;
                                                    link.download = `angle_${i}_${Date.now()}.png`;
                                                    document.body.appendChild(link);
                                                    link.click();
                                                    document.body.removeChild(link);
                                                }}
                                                title={language === "tr" ? "ƒ∞ndir" : "Download"}
                                            >
                                                <Download className="w-3.5 h-3.5" />
                                            </Button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            /* Single Main Image */
                            <div className="relative aspect-[2/3] w-full rounded-2xl overflow-hidden shadow-2xl border bg-white group">
                                <img src={resultImages[0]} className="w-full h-full object-cover" />
                                {/* Download Button - Always Visible */}
                                <Button
                                    size="icon"
                                    className="absolute top-4 right-4 bg-black/50 hover:bg-black/70 text-white p-2.5 rounded-full backdrop-blur-md transition-all shadow-lg z-20 flex items-center justify-center h-10 w-10"
                                    onClick={async (e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        const response = await fetch(resultImages[0]);
                                        const blob = await response.blob();
                                        const url = window.URL.createObjectURL(blob);
                                        const link = document.createElement('a');
                                        link.href = url;
                                        link.download = `styling_${Date.now()}.png`;
                                        document.body.appendChild(link);
                                        link.click();
                                        document.body.removeChild(link);
                                    }}
                                    title={language === "tr" ? "ƒ∞ndir" : "Download"}
                                >
                                    <Download className="w-5 h-5" />
                                </Button>
                            </div>
                        )}

                        {/* Action Buttons Row */}
                    </div>
                ) : (
                    <div className="my-auto flex flex-col items-center justify-center text-center text-muted-foreground opacity-50">
                        <div className="w-32 h-32 bg-muted rounded-full flex items-center justify-center mb-4">
                            <ImageIcon className="w-12 h-12" />
                        </div>
                        <h3 className="font-semibold text-lg">{language === "tr" ? "√ñnizleme Alanƒ±" : "Preview Area"}</h3>
                        <p className="text-sm">{language === "tr" ? "Olu≈üturulan g√∂rsel burada g√∂r√ºnecek" : "Generated image will appear here"}</p>
                    </div>
                )}
            </div>

            {/* COLUMN 3: History (Right Sidebar) */}
            <div className="hidden xl:block w-[200px] border-l bg-background p-4 overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="font-semibold text-sm">{language === "tr" ? "Ge√ßmi≈ü" : "History"}</h3>
                </div>
                <div className="space-y-3">
                    {projects.filter(p => p.type === "Photoshoot").length > 0 ? (
                        projects.filter(p => p.type === "Photoshoot").slice(0, 10).map((item) => (
                            <div
                                key={item.id}
                                className="aspect-[3/4] rounded-lg overflow-hidden border border-border bg-muted cursor-pointer hover:ring-2 hover:ring-violet-500 transition-all relative group"
                                onClick={() => router.push(`/history?id=${item.id}`)}
                            >
                                <img src={item.imageUrl} className="w-full h-full object-cover" />
                                <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-end p-2">
                                    <p className="text-[10px] text-white font-medium truncate">{item.title}</p>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div className="text-xs text-muted-foreground text-center py-8">
                            {language === "tr" ? "Hen√ºz i≈ülem yok" : "No history yet"}
                        </div>
                    )}
                </div>
            </div>

            {/* Preview Dialog */}
            <Dialog open={showPreview} onOpenChange={setShowPreview}>
                <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
                    <DialogHeader>
                        <DialogTitle>
                            {language === "tr" ? "Olu≈üturma √ñnizlemesi" : "Generation Preview"}
                            {pendingOptions?.isThreeAngles && (
                                <span className="text-sm font-normal text-muted-foreground ml-2 block sm:inline mt-1 sm:mt-0">
                                    {language === "tr" ? "(3 A√ßƒ±lƒ± √áekim - √ñn Referans)" : "(3-Angle Shot - Front Reference)"}
                                </span>
                            )}
                        </DialogTitle>
                    </DialogHeader>

                    {previewData && (
                        <div className="space-y-6">
                            {previewData.map((item: any, idx: number) => (
                                <div key={idx} className="border rounded-lg p-4 bg-muted/50">
                                    <div className="flex items-center justify-between mb-3">
                                        <h4 className="font-semibold flex items-center gap-2">
                                            <FileText className="w-4 h-4 text-primary" />
                                            {item.title || (language === "tr" ? "Olu≈üturma ƒ∞stemi" : "Generation Prompt")}
                                        </h4>
                                        <div className="flex items-center gap-2">
                                            <Button
                                                variant={previewMode === 'text' ? 'default' : 'ghost'}
                                                size="sm"
                                                className="h-7 text-[10px]"
                                                onClick={() => setPreviewMode('text')}
                                            >
                                                Text
                                            </Button>
                                            <Button
                                                variant={previewMode === 'json' ? 'default' : 'ghost'}
                                                size="sm"
                                                className="h-7 text-[10px]"
                                                onClick={() => {
                                                    setPreviewMode('json');
                                                    if (previewData && previewData[0]) {
                                                        setUserAddedPrompt(JSON.stringify(previewData[0].structured, null, 2));
                                                    }
                                                }}
                                            >
                                                JSON
                                            </Button>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2 mb-2">
                                        <Button
                                            variant={previewMode === 'text' ? 'secondary' : 'ghost'}
                                            size="sm"
                                            className="h-6 text-[9px]"
                                            onClick={() => {
                                                setPreviewMode('text');
                                                if (previewData && previewData[0]) {
                                                    setUserAddedPrompt(previewData[0].prompt);
                                                }
                                            }}
                                        >
                                            {language === "tr" ? "Metne D√∂n" : "Switch to Text"}
                                        </Button>
                                    </div>

                                    <div className="space-y-2">
                                        <div className="space-y-4">
                                            <textarea
                                                className="w-full p-4 text-[12px] border rounded-lg bg-[#0a0a0a] text-green-400 min-h-[350px] font-mono leading-relaxed focus:ring-1 focus:ring-green-500/50 outline-none scrollbar-thin scrollbar-thumb-card"
                                                value={userAddedPrompt}
                                                onChange={(e) => setUserAddedPrompt(e.target.value)}
                                                spellCheck={false}
                                            />
                                            {previewMode === 'json' && (
                                                <p className="text-[10px] text-muted-foreground italic px-1">
                                                    {language === "tr" ? "JSON'u d√ºzenleyerek √ßekim detaylarƒ±nƒ± deƒüi≈ütirebilirsiniz." : "You can modify shot details by editing the JSON above."}
                                                </p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="mt-3 flex items-center gap-2 text-[10px] text-muted-foreground">
                                        <div className="flex items-center gap-1 px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                                            <span>Resolution: {item.settings.resolution}</span>
                                        </div>
                                        <div className="flex items-center gap-1 px-2 py-0.5 rounded-full bg-violet-50 text-violet-700 border border-violet-100">
                                            <span>Ratio: {item.settings.aspect_ratio}</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                            <div className="flex justify-end gap-3 pt-4">
                                <Button variant="outline" onClick={() => setShowPreview(false)}>
                                    {language === "tr" ? "ƒ∞ptal" : "Cancel"}
                                </Button>
                                <Button onClick={handleConfirmGeneration} className="bg-violet-600 hover:bg-violet-700">
                                    <Sparkles className="w-4 h-4 mr-2" />
                                    {language === "tr" ? "Onayla ve Olu≈ütur" : "Confirm & Generate"}
                                </Button>
                            </div>
                        </div>
                    )}
                </DialogContent>
            </Dialog>

            {/* Save Pose Dialog */}
            <Dialog open={showSavePoseDialog} onOpenChange={setShowSavePoseDialog}>
                <DialogContent className="sm:max-w-[425px]">
                    <DialogHeader>
                        <DialogTitle>{language === "tr" ? "Pozu Kaydet" : "Save Pose"}</DialogTitle>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="flex items-center justify-center">
                            {tempPoseData && (
                                <div className="relative w-32 h-48 rounded-md overflow-hidden border">
                                    <img src={tempPoseData.original} alt="Original" className="w-full h-full object-cover" />
                                    <div className="absolute inset-0 bg-black/50 flex items-center justify-center">
                                        <Sparkles className="w-8 h-8 text-white animate-pulse" />
                                    </div>
                                </div>
                            )}
                        </div>
                        <p className="text-center text-sm text-muted-foreground">{language === "tr" ? "Stickman olu≈üturmadan √∂nce pozu kaydetmek ister misiniz?" : "Do you want to save this to library before converting?"}</p>
                        <div className="flex gap-2 justify-center mt-2">
                            <Button variant="outline" onClick={() => handleSavePose('female')} className="gap-2">
                                <User className="w-4 h-4 text-pink-500" />
                                {language === "tr" ? "Kadƒ±n Olarak Kaydet" : "Save as Female"}
                            </Button>
                            <Button variant="outline" onClick={() => handleSavePose('male')} className="gap-2">
                                <User className="w-4 h-4 text-blue-500" />
                                {language === "tr" ? "Erkek Olarak Kaydet" : "Save as Male"}
                            </Button>
                        </div>
                        <Button variant="ghost" onClick={() => handleSavePose('skip')} className="w-full mt-2 text-xs text-muted-foreground">
                            {language === "tr" ? "Kaydetme, Sadece D√∂n√º≈üt√ºr" : "Don't Save, Just Convert"}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>

            {/* Save Model Dialog */}
            <Dialog open={showSaveModelDialog} onOpenChange={setShowSaveModelDialog}>
                <DialogContent className="sm:max-w-[425px]">
                    <DialogHeader>
                        <DialogTitle>{language === "tr" ? "Modeli Kaydet" : "Save Model"}</DialogTitle>
                    </DialogHeader>
                    {tempModelData && (
                        <div className="grid gap-4 py-4">
                            {/* Image Preview */}
                            <div className="flex items-center justify-center">
                                <div className="relative w-32 h-48 rounded-md overflow-hidden border bg-muted">
                                    <img src={tempModelData.url} alt="Model" className="w-full h-full object-cover" />
                                </div>
                            </div>

                            {/* Name Input */}
                            <div className="space-y-1">
                                <label className="text-xs font-medium text-muted-foreground">{language === "tr" ? "Model Adƒ±" : "Model Name"}</label>
                                <input
                                    type="text"
                                    className="w-full text-sm p-2 rounded-lg border bg-background"
                                    placeholder={language === "tr" ? "Model Adƒ± Girin" : "Enter Model Name"}
                                    value={tempModelData.name}
                                    onChange={(e) => setTempModelData({ ...tempModelData, name: e.target.value })}
                                />
                            </div>

                            {/* Gender Selection */}
                            <div className="grid grid-cols-2 gap-2">
                                <div
                                    onClick={() => setTempModelData({ ...tempModelData, gender: 'female' })}
                                    className={`cursor-pointer rounded-lg border p-2 flex items-center justify-center gap-2 transition-all ${tempModelData.gender === 'female' ? 'bg-violet-100 border-violet-500 text-violet-700' : 'bg-muted/30 hover:bg-muted'}`}
                                >
                                    <span className="text-xs font-medium">{language === "tr" ? "Kadƒ±n" : "Female"}</span>
                                </div>
                                <div
                                    onClick={() => setTempModelData({ ...tempModelData, gender: 'male' })}
                                    className={`cursor-pointer rounded-lg border p-2 flex items-center justify-center gap-2 transition-all ${tempModelData.gender === 'male' ? 'bg-blue-100 border-blue-500 text-blue-700' : 'bg-muted/30 hover:bg-muted'}`}
                                >
                                    <span className="text-xs font-medium">{language === "tr" ? "Erkek" : "Male"}</span>
                                </div>
                            </div>

                            <Button onClick={handleSaveModel} className="w-full bg-violet-600 hover:bg-violet-700 mt-2">
                                {language === "tr" ? "Kaydet ve Se√ß" : "Save & Select"}
                            </Button>
                        </div>
                    )}
                </DialogContent>
            </Dialog>
            {/* Save Asset Dialog (Generic) */}
            <Dialog open={showSaveAssetDialog} onOpenChange={setShowSaveAssetDialog}>
                <DialogContent className="sm:max-w-[400px]">
                    <DialogHeader>
                        <DialogTitle>{language === "tr" ? "K√ºt√ºphaneye Kaydet" : "Save to Library"}</DialogTitle>
                    </DialogHeader>
                    {tempAssetData && (
                        <div className="space-y-4 py-4">
                            <div className="flex justify-center">
                                <div className="w-32 h-32 rounded-lg border overflow-hidden">
                                    <img src={tempAssetData.url} className="w-full h-full object-cover" />
                                </div>
                            </div>
                            <div className="space-y-1">
                                <label className="text-xs font-medium">{language === "tr" ? "√ñƒüe Adƒ±" : "Item Name"}</label>
                                <input
                                    type="text"
                                    className="w-full text-sm p-2 rounded-lg border bg-background"
                                    value={tempAssetData.name}
                                    onChange={(e) => setTempAssetData({ ...tempAssetData, name: e.target.value })}
                                />
                            </div>
                            <Button onClick={handleSaveAsset} className="w-full bg-violet-600 hover:bg-violet-700">
                                {language === "tr" ? "Kaydet" : "Save"}
                            </Button>
                        </div>
                    )}
                </DialogContent>
            </Dialog>

            {/* Edit Item Dialog */}
            <Dialog open={!!editingThumbItem} onOpenChange={(open) => { if (!open) setEditingThumbItem(null); }}>
                <DialogContent className="sm:max-w-[400px]">
                    <DialogHeader>
                        <DialogTitle>{language === "tr" ? "√ñƒüeyi D√ºzenle" : "Edit Item"}</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-6 py-4">
                        <div className="flex flex-col items-center gap-2">
                            <label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider">
                                {language === "tr" ? "K√ºt√ºphane G√∂rseli" : "Library Thumbnail"}
                            </label>
                            <label className="w-32 h-44 rounded-lg border border-dashed flex flex-col items-center justify-center bg-muted/30 cursor-pointer overflow-hidden relative group hover:bg-muted/50 transition-all">
                                <input
                                    type="file"
                                    className="hidden"
                                    accept="image/*"
                                    onChange={(e) => {
                                        if (e.target.files?.[0]) handleUpdateThumbnail(e.target.files[0]);
                                    }}
                                />
                                {editingThumbItem && (editingThumbItem.type === 'pose' ? savedPoses : savedModels).find(i => i.id === editingThumbItem.id)?.thumbUrl ? (
                                    <div className="relative w-full h-full">
                                        <img
                                            src={(editingThumbItem.type === 'pose' ? savedPoses : savedModels).find(i => i.id === editingThumbItem.id)?.thumbUrl}
                                            className="w-full h-full object-cover"
                                        />
                                        <div className="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                            <RotateCw className="text-white w-6 h-6 animate-spin-slow" />
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center gap-1">
                                        <ImageIcon className="w-8 h-8 text-muted-foreground" />
                                        <span className="text-[10px] text-muted-foreground font-medium">Deƒüi≈ütir</span>
                                    </div>
                                )}
                            </label>
                        </div>

                        {(editingThumbItem?.type === 'pose' || editingThumbItem?.type === 'fit_pattern') && (
                            <div className="space-y-2">
                                <label className="text-xs font-semibold text-muted-foreground uppercase tracking-wider flex items-center gap-2">
                                    <FileText size={12} />
                                    {editingThumbItem.type === 'pose'
                                        ? (language === "tr" ? "Poz Prompt A√ßƒ±klamasƒ±" : "Pose Prompt Description")
                                        : (language === "tr" ? "Kalƒ±p/Desen Prompt A√ßƒ±klamasƒ±" : "Fit/Pattern Prompt Description")}
                                </label>
                                <textarea
                                    className="w-full h-32 text-sm p-3 rounded-lg border bg-background focus:ring-2 focus:ring-violet-500 outline-none resize-none"
                                    placeholder={editingThumbItem.type === 'pose'
                                        ? (language === "tr" ? "√ñrn: Yan duran model, kameraya bakmadan 90 derece duruyor" : "e.g. Model standing sideways, looking 90 degrees away from camera")
                                        : (language === "tr" ? "√ñrn: Bol kesim baggy pantolon, pa√ßalarƒ± ayakkabƒ±nƒ±n √ºst√ºne yƒ±ƒüƒ±lƒ±yor" : "e.g. Oversized baggy pants, hem stacking over shoes")
                                    }
                                    value={editingItemPrompt}
                                    onChange={(e) => setEditingItemPrompt(e.target.value)}
                                />
                            </div>
                        )}

                        <Button
                            onClick={() => handleUpdateThumbnail(null)}
                            className="w-full bg-violet-600 hover:bg-violet-700 font-semibold"
                        >
                            {language === "tr" ? "G√ºncelle ve Kaydet" : "Update & Save"}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>

            {/* BATCH PREVIEW DIALOG */}
            <Dialog open={showBatchPreview} onOpenChange={setShowBatchPreview}>
                <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
                    <DialogHeader>
                        <DialogTitle className="flex items-center gap-2">
                            <Package className="w-5 h-5 text-blue-600" />
                            {language === "tr" ? "Toplu √úretim √ñnizleme" : "Batch Generation Preview"}
                        </DialogTitle>
                        <DialogDescription>
                            {language === "tr"
                                ? `${batchPreviewPrompts.length} g√∂rsel i√ßin promptlar. ƒ∞sterseniz d√ºzenleyebilirsiniz.`
                                : `Prompts for ${batchPreviewPrompts.length} images. You can edit them if needed.`
                            }
                        </DialogDescription>
                    </DialogHeader>
                    <div className="flex-1 overflow-y-auto space-y-4 p-4">
                        {batchPreviewPrompts.map((p, idx) => (
                            <div key={idx} className="space-y-2 p-3 bg-muted/30 rounded-lg border">
                                <label className="text-sm font-semibold text-blue-600">{p.title}</label>
                                <Textarea
                                    value={editedBatchPrompts[idx]}
                                    onChange={(e) => {
                                        const updated = [...editedBatchPrompts];
                                        updated[idx] = e.target.value;
                                        setEditedBatchPrompts(updated);
                                    }}
                                    className="font-mono text-xs h-32 bg-background"
                                />
                            </div>
                        ))}
                    </div>
                    <div className="flex gap-2 p-4 border-t">
                        <Button variant="outline" onClick={() => setShowBatchPreview(false)} className="flex-1">
                            {language === "tr" ? "ƒ∞ptal" : "Cancel"}
                        </Button>
                        <Button onClick={handleConfirmBatchGeneration} className="flex-1 bg-blue-600 hover:bg-blue-700">
                            {language === "tr" ? "Onayla ve √úret" : "Confirm & Generate"}
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>

            {/* BATCH RESULTS DISPLAY */}
            {batchMode && batchResultImages.length > 0 && (
                <Dialog open={batchResultImages.length > 0} onOpenChange={() => setBatchResultImages([])}>
                    <DialogContent className="max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
                        <DialogHeader>
                            <DialogTitle className="flex items-center gap-2">
                                <Package className="w-5 h-5 text-blue-600" />
                                {language === "tr" ? "Toplu √úretim Sonu√ßlarƒ±" : "Batch Generation Results"}
                            </DialogTitle>
                            <DialogDescription>
                                {language === "tr"
                                    ? `${batchResultImages.length} g√∂rsel ba≈üarƒ±yla olu≈üturuldu`
                                    : `${batchResultImages.length} images generated successfully`
                                }
                            </DialogDescription>
                        </DialogHeader>
                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                {batchResultImages.map((img, idx) => (
                                    <div key={idx} className="relative group">
                                        <img src={img.url} className="w-full rounded-lg shadow-lg border bg-white" alt={img.filename} />
                                        <div className="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded">
                                            {img.filename}
                                        </div>
                                    </div>
                                ))}
                                {colorPalette && (
                                    <div className="relative group">
                                        <img src={colorPalette} className="w-full rounded-lg shadow-lg border bg-white" alt="Color Palette" />
                                        <div className="absolute bottom-2 left-2 bg-black/70 text-white text-xs px-2 py-1 rounded flex items-center gap-1">
                                            <Gem className="w-3 h-3" />
                                            {language === "tr" ? "Renk Paleti" : "Color Palette"}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="flex gap-2 p-4 border-t">
                            <Button onClick={() => setBatchResultImages([])} className="flex-1">
                                {language === "tr" ? "Kapat" : "Close"}
                            </Button>
                        </div>
                    </DialogContent>
                </Dialog>
            )}
        </div>
    );
}
